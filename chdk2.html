<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æœºå™¨äººç‰©è”ç½‘äº‘æ§ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* è·¯å¾„è§„åˆ’æ ·å¼ */
      #path-planning-canvas {
        background: #1a202c;
        border: 2px solid #2d3748;
        border-radius: 8px;
        cursor: crosshair;
      }

      .path-planning-tab .map-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .map-control-btn.active {
        background: #4299e1;
        border-color: #4299e1;
      }

      .map-control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .point-list {
        background: #2d3748;
        border-radius: 5px;
        overflow-y: auto;
      }

      .point-list ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .point-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        border-bottom: 1px solid #4a5568;
      }

      .point-list li:last-child {
        border-bottom: none;
      }

      .point-info {
        flex: 1;
      }

      .point-actions button {
        background: #e53e3e;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
      }

      .point-actions button:hover {
        background: #c53030;
      }

      .map-toolbar {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 5px;
      }

      .map-toolbar button {
        background: #4299e1;
        color: white;
        border: none;
        padding: 5px 10px;
        margin: 2px;
        border-radius: 3px;
        cursor: pointer;
      }

      .map-toolbar button:hover {
        background: #3182ce;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #0d1b2a, #1b263b);
        color: #fff;
        min-height: 100vh;
        padding: 20px;
        overflow-x: hidden;
      }

      .header {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(16, 42, 67, 0.8);
        border-radius: 15px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
      }

      .header h1 {
        font-size: 2.2rem;
        color: #4d9be6;
        text-shadow: 0 0 10px rgba(77, 155, 230, 0.3);
        letter-spacing: 1px;
      }

      .header p {
        font-size: 1rem;
        opacity: 0.8;
        margin-top: 8px;
      }

      .connection-status {
        display: flex;
        justify-content: center;
        margin-top: 12px;
        font-weight: 500;
      }

      .status-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #00c853;
        box-shadow: 0 0 10px #00c853;
        margin-right: 10px;
        margin-top: 5px;
      }

      .container {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 20px;
        height: calc(100vh - 150px);
        max-width: 1800px;
        margin: 0 auto;
      }

      /* å·¦ä¾§å¯¼èˆª */
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
        height: 100%;
        overflow-y: auto;
        padding-right: 5px;
      }

      .sidebar::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: rgba(100, 181, 246, 0.5);
        border-radius: 3px;
      }

      .control-section {
        background: rgba(16, 42, 67, 0.8);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        padding: 20px;
        backdrop-filter: blur(4px);
        border: 1px solid rgba(66, 133, 244, 0.15);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .section-header h2 {
        font-size: 1.4rem;
        color: #64b5f6;
      }

      .section-header .actions button {
        background: rgba(66, 133, 244, 0.2);
        border: none;
        color: #fff;
        padding: 6px 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 10px;
        font-size: 0.85rem;
      }

      .section-header .actions button:hover {
        background: rgba(66, 133, 244, 0.4);
      }

      /* æ–¹å‘æ§åˆ¶ */
      .joystick-container {
        background: rgba(21, 48, 77, 0.5);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
      }

      #directional-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 10px;
        margin-top: 10px;
      }

      .control-btn {
        height: 70px;
        border-radius: 10px;
        background: rgba(41, 98, 255, 0.12);
        border: 1px solid rgba(66, 133, 244, 0.2);
        color: #fff;
        font-size: 1.4rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .control-btn:hover {
        background: rgba(41, 98, 255, 0.25);
        transform: translateY(-2px);
      }

      .control-btn:active {
        transform: translateY(0);
      }

      #btn-forward {
        grid-column: 2;
        grid-row: 1;
      }

      #btn-left {
        grid-column: 1;
        grid-row: 2;
      }

      #btn-right {
        grid-column: 3;
        grid-row: 2;
      }

      #btn-back {
        grid-column: 2;
        grid-row: 3;
      }

      #btn-rotate-left {
        grid-column: 1;
        grid-row: 1;
      }

      #btn-rotate-right {
        grid-column: 3;
        grid-row: 1;
      }

      #btn-stop {
        grid-column: 2;
        grid-row: 2;
        background: rgba(224, 44, 44, 0.3);
      }

      #btn-stop:hover {
        background: rgba(224, 44, 44, 0.5);
      }

      /* é€Ÿåº¦æ§åˆ¶ */
      .speed-control {
        background: rgba(21, 48, 77, 0.5);
        border-radius: 12px;
        padding: 15px;
        margin-top: 20px;
      }

      .speed-wrapper {
        display: flex;
        flex-direction: column;
      }

      .speed-display {
        font-size: 1.5rem;
        text-align: center;
        margin: 15px 0;
        font-weight: 600;
      }

      .speed-display .value {
        color: #76ff03;
        font-size: 2rem;
      }

      .speed-slider {
        width: 100%;
        margin: 15px 0;
        -webkit-appearance: none;
        height: 8px;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.08);
        outline: none;
      }

      .speed-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #4285f4;
        cursor: pointer;
        box-shadow: 0 0 8px rgba(66, 133, 244, 0.8);
      }

      /* å®‰å…¨æ§åˆ¶é¢æ¿ */
      .safety-control {
        background: rgba(21, 48, 77, 0.5);
        border-radius: 12px;
        padding: 15px;
        margin-top: 20px;
      }

      .emergency-button {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: #e74c3c;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        margin: 0 auto 15px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        border: 3px solid #fff;
      }

      .emergency-button:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 25px rgba(231, 76, 60, 0.6);
      }

      .emergency-button:active {
        transform: scale(0.95);
        background: #c0392b;
      }

      .emergency-button.active {
        background: #c0392b;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
        }
        70% {
          box-shadow: 0 0 0 15px rgba(231, 76, 60, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
        }
      }

      .safety-status {
        display: flex;
        justify-content: space-around;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .safety-status-item {
        flex: 1;
        min-width: 120px;
        margin: 5px;
        padding: 10px;
        border-radius: 6px;
        background: #f8f9fa;
        text-align: center;
      }

      .safety-level-normal {
        background: #d4edda;
        color: #155724;
      }
      .safety-level-warning {
        background: #fff3cd;
        color: #856404;
      }
      .safety-level-danger {
        background: #f8d7da;
        color: #721c24;
      }
      .safety-level-emergency {
        background: #f5b7b1;
        color: #78281f;
      }

      /* IMUä»ªè¡¨ç›˜ */
      .imu-dashboard {
        background: rgba(21, 48, 77, 0.5);
        border-radius: 12px;
        padding: 15px;
        margin-top: 20px;
      }

      .imu-container {
        display: flex;
        height: 150px;
        margin-top: 10px;
      }

      .imu-box {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .imu-value {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        position: relative;
      }

      .imu-value .label {
        position: absolute;
        top: -22px;
        font-size: 0.85rem;
        opacity: 0.8;
      }

      .roll {
        background: rgba(255, 152, 0, 0.15);
        color: #ff9800;
      }
      .pitch {
        background: rgba(76, 175, 80, 0.15);
        color: #4caf50;
      }
      .yaw {
        background: rgba(33, 150, 243, 0.15);
        color: #2196f3;
      }

      /* æ€§èƒ½ç›‘æ§ */
      .performance-monitor {
        background: rgba(21, 48, 77, 0.5);
        border-radius: 12px;
        padding: 15px;
        margin-top: 20px;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }

      .metric-item {
        text-align: center;
        padding: 10px;
        background: rgba(10, 25, 47, 0.3);
        border-radius: 6px;
      }

      .metric-label {
        font-size: 0.8em;
        color: #7f8c8d;
        margin-bottom: 5px;
      }

      .metric-value {
        font-size: 1.1em;
        font-weight: bold;
        color: #64b5f6;
      }

      /* ä¸»å†…å®¹åŒº - æ ‡ç­¾é¡µ */
      .main-content {
        background: rgba(16, 42, 67, 0.8);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        display: grid;
        grid-template-rows: auto 1fr;
        overflow: hidden;
      }

      .tabs {
        display: flex;
        padding: 0 20px;
        background: rgba(12, 28, 45, 0.7);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .tab-btn {
        padding: 14px 24px;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.6);
        font-size: 1rem;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
      }

      .tab-btn:hover {
        color: #64b5f6;
      }

      .tab-btn.active {
        color: #4d9be6;
        font-weight: 600;
      }

      .tab-btn.active::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: #4d9be6;
        border-radius: 3px 3px 0 0;
      }

      /* SLAMåœ°å›¾åŒºåŸŸ */
      .tab-content {
        display: none;
        height: 100%;
        overflow: hidden;
      }

      .tab-content.active {
        display: grid;
        grid-template-rows: auto 1fr 280px;
        height: 100%;
      }

      .slam-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: rgba(12, 28, 45, 0.7);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .slam-header h2 {
        font-size: 1.6rem;
        color: #64b5f6;
      }

      .map-controls {
        display: flex;
        gap: 15px;
      }

      .map-control-btn {
        background: rgba(66, 133, 244, 0.2);
        border: none;
        color: #fff;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .map-control-btn:hover {
        background: rgba(66, 133, 244, 0.4);
      }

      .map-actions {
        display: flex;
        gap: 10px;
        margin-left: 20px;
      }

      .map-container {
        position: relative;
        background: #091a2f;
        overflow: hidden;
        height: 100%;
      }

      #slam-map-canvas {
        width: 100%;
        height: 100%;
        background: #091a2f;
        cursor: crosshair;
      }

      /* å¯¼èˆªç‚¹æ§åˆ¶åŒº */
      .navigation-section {
        padding: 15px;
        background: rgba(12, 28, 45, 0.7);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }

      .nav-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .point-list {
        height: 190px;
        overflow-y: auto;
        background: rgba(10, 25, 47, 0.3);
        border-radius: 10px;
        padding: 10px;
      }

      .point-list ul {
        list-style: none;
      }

      .point-list li {
        padding: 12px;
        margin-bottom: 8px;
        background: rgba(41, 98, 255, 0.1);
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .point-info {
        display: flex;
        gap: 15px;
      }

      .point-actions {
        display: flex;
        gap: 10px;
      }

      .point-actions button {
        background: none;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        border-radius: 6px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 0.85rem;
      }

      .point-actions button:hover {
        background: rgba(66, 133, 244, 0.2);
      }

      /* ä»»åŠ¡ç®¡ç†é¡µé¢ */
      .task-manager {
        padding: 20px;
        display: grid;
        grid-template-rows: auto 1fr;
        height: 100%;
        gap: 20px;
      }

      .task-form {
        background: rgba(12, 28, 45, 0.7);
        border-radius: 12px;
        padding: 20px;
      }

      .form-header {
        margin-bottom: 20px;
        color: #64b5f6;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
      }

      .form-group {
        flex: 1;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 0.9rem;
        opacity: 0.8;
      }

      .form-group select,
      .form-group input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        background: rgba(21, 48, 77, 0.5);
        border: 1px solid rgba(64, 124, 225, 0.3);
        color: white;
      }

      .add-btn {
        background: rgba(66, 133, 244, 0.4);
        border: none;
        color: white;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
      }

      .add-btn:hover {
        background: rgba(66, 133, 244, 0.6);
      }

      .task-list-container {
        background: rgba(12, 28, 45, 0.7);
        border-radius: 12px;
        padding: 20px;
        overflow-y: auto;
      }

      .task-list-header {
        display: grid;
        grid-template-columns: 1fr 120px 100px 120px 150px 120px;
        padding: 15px;
        font-weight: 600;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .task-item {
        display: grid;
        grid-template-columns: 1fr 120px 100px 120px 150px 120px;
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.3s ease;
      }

      .task-item:hover {
        background: rgba(41, 98, 255, 0.1);
      }

      .task-id {
        font-weight: 600;
        color: #64b5f6;
      }

      .action-btn {
        background: none;
        border: none;
        color: #64b5f6;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .action-btn:hover {
        opacity: 0.9;
        text-decoration: underline;
      }

      .status-pending {
        color: #ff9800;
      }

      .status-in-progress {
        color: #2196f3;
      }

      .status-completed {
        color: #4caf50;
      }

      .priority-high {
        color: #f44336;
        font-weight: 600;
      }

      .priority-medium {
        color: #ffc107;
      }

      .priority-low {
        color: #64b5f6;
      }

      .battery-container {
        margin-top: 20px;
        background: rgba(21, 48, 77, 0.5);
        border-radius: 12px;
        padding: 15px;
        display: flex;
        flex-direction: column;
      }

      .battery-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        color: #64b5f6;
        gap: 10px;
      }

      .battery-progress {
        height: 25px;
        background: rgba(10, 25, 47, 0.3);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
      }

      .battery-fill {
        height: 100%;
        width: 72%;
        background: linear-gradient(90deg, #00c853, #76ff03);
        border-radius: 12px 0 0 12px;
        position: relative;
      }

      .battery-percentage {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .battery-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 12px;
        font-size: 0.9rem;
      }

      .stat-item div:first-child {
        opacity: 0.7;
        margin-bottom: 5px;
      }

      /* åœ°å›¾å¯¼èˆªç‚¹æ ·å¼ */
      .map-nav-point {
        position: absolute;
        width: 25px;
        height: 25px;
        background: #ff4081;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 10px rgba(255, 64, 129, 0.7);
        border: 2px solid #fff;
        user-select: none;
        z-index: 10;
      }

      .map-nav-point::after {
        content: "";
        position: absolute;
        top: -50px;
        left: calc(50% - 1.5px);
        height: 50px;
        width: 3px;
        background: #ff4081;
        z-index: -1;
      }

      .map-nav-point span {
        font-weight: bold;
        font-size: 14px;
        color: white;
      }

      /* åæ ‡æ˜¾ç¤º */
      .coordinates-display {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        z-index: 100;
      }

      /* åœ°å›¾æ§åˆ¶é¢æ¿ */
      .map-toolbar {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(16, 42, 67, 0.9);
        border-radius: 8px;
        padding: 10px;
        z-index: 50;
      }

      .map-toolbar button {
        background: rgba(66, 133, 244, 0.3);
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        margin: 2px;
        font-size: 0.8rem;
      }

      .map-toolbar button:hover {
        background: rgba(66, 133, 244, 0.5);
      }

      /* å®‰å…¨æ—¥å¿— */
      .safety-logs {
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 8px;
        height: 150px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
        margin-top: 15px;
      }

      .safety-logs div {
        margin-bottom: 5px;
        padding: 5px 0;
        border-bottom: 1px solid #444;
      }

      .log-normal {
        color: #27ae60;
      }
      .log-warning {
        color: #f39c12;
      }
      .log-danger {
        color: #e74c3c;
      }
      .log-emergency {
        color: #ff6b6b;
        font-weight: bold;
      }

      /* æ§åˆ¶ä¼˜åŒ–é¢æ¿ */
      .control-optimization {
        background: rgba(21, 48, 77, 0.5);
        border-radius: 12px;
        padding: 15px;
        margin-top: 20px;
      }

      .optimization-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }

      .optimization-controls button {
        background: rgba(66, 133, 244, 0.3);
        border: none;
        color: white;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        flex: 1;
      }

      .optimization-controls button:hover {
        background: rgba(66, 133, 244, 0.5);
      }

      /* åŠ¨ç”»æ•ˆæœ */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .control-btn,
      .map-control-btn {
        animation: fadeIn 0.4s ease forwards;
      }

      .active {
        background: rgba(66, 133, 244, 0.4) !important;
      }

      /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .tab-content {
        animation: slideIn 0.3s ease-out;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-height: 900px) {
        .container {
          height: auto;
          min-height: calc(100vh - 150px);
        }

        .joystick-container,
        .speed-control,
        .imu-dashboard,
        .battery-container {
          padding: 12px;
        }

        .control-btn {
          height: 60px;
          font-size: 1.2rem;
        }

        .imu-container {
          height: 130px;
        }

        .imu-value {
          width: 80px;
          height: 80px;
          font-size: 1rem;
        }

        .speed-display {
          font-size: 1.3rem;
          margin: 10px 0;
        }

        .speed-display .value {
          font-size: 1.7rem;
        }
      }

      @media (max-width: 1400px) {
        .container {
          grid-template-columns: 280px 1fr;
        }

        .control-btn {
          height: 60px;
        }

        .imu-container {
          height: 130px;
        }

        .imu-value {
          width: 80px;
          height: 80px;
        }
      }

      @media (max-width: 1200px) {
        .container {
          grid-template-columns: 1fr;
          grid-template-rows: auto 1fr;
        }

        .sidebar {
          flex-direction: row;
          overflow-x: auto;
          height: auto;
          padding-bottom: 10px;
        }

        .control-section {
          min-width: 300px;
          flex: 1;
        }

        .main-content {
          min-height: 600px;
        }
      }
    </style>
  </head>
  <body>
    <!-- é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ -->
    <div class="header">
      <h1><i class="fas fa-robot"></i> æœºå™¨äººç‰©è”ç½‘äº‘æ§ç³»ç»Ÿ</h1>
      <p>åŸºäºSLAMæŠ€æœ¯çš„è‡ªä¸»å¯¼èˆªä¸æ™ºèƒ½ä»»åŠ¡ç®¡ç† - é›†æˆå®‰å…¨æ§åˆ¶ä¸æ€§èƒ½ä¼˜åŒ–</p>
      <div class="connection-status">
        <div class="status-dot" id="status-dot"></div>
        <span id="connection-text"
          >ç³»ç»Ÿå·²è¿æ¥ - å»¶è¿Ÿ: 18ms - ç³»ç»ŸçŠ¶æ€: æ­£å¸¸è¿è¡Œ</span
        >
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="container">
      <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
      <div class="sidebar">
        <div class="control-section">
          <div class="section-header">
            <h2><i class="fas fa-gamepad"></i> è¿åŠ¨æ§åˆ¶</h2>
            <div class="actions">
              <button id="btn-switch-mode">
                <i class="fas fa-exchange-alt"></i> æ¨¡å¼
              </button>
            </div>
            <h2><i class="fas fa-map"></i> SLAMå»ºå›¾æ§åˆ¶</h2>
          </div>
          <div
            class="slam-control"
            style="
              background: rgba(21, 48, 77, 0.5);
              border-radius: 12px;
              padding: 15px;
              margin-top: 10px;
            "
          >
            <div
              class="slam-status"
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 15px;
              "
            >
              <div>
                <strong>å»ºå›¾çŠ¶æ€:</strong>
                <span id="slam-status" style="color: #e74c3c">æœªå¯åŠ¨</span>
              </div>
              <div>
                <strong>åœ°å›¾å°ºå¯¸:</strong>
                <span id="map-size">0 x 0</span>
              </div>
            </div>

            <div
              class="slam-controls"
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
            >
              <button
                class="map-control-btn"
                onclick="startSLAMMapping()"
                id="btn-start-slam"
              >
                <i class="fas fa-play"></i> å¼€å§‹å»ºå›¾
              </button>
              <button
                class="map-control-btn"
                onclick="stopSLAMMapping()"
                id="btn-stop-slam"
                disabled
              >
                <i class="fas fa-stop"></i> åœæ­¢å»ºå›¾
              </button>
              <button
                class="map-control-btn"
                onclick="saveMap()"
                id="btn-save-map"
              >
                <i class="fas fa-save"></i> ä¿å­˜åœ°å›¾
              </button>
              <button
                class="map-control-btn"
                onclick="resetMap()"
                id="btn-reset-map"
              >
                <i class="fas fa-redo"></i> é‡ç½®åœ°å›¾
              </button>
            </div>

            <div
              class="slam-stats"
              style="margin-top: 15px; font-size: 0.9rem; color: #7f8c8d"
            >
              <div>å·²æ¢ç´¢åŒºåŸŸ: <span id="explored-area">0%</span></div>
              <div>éšœç¢ç‰©æ•°é‡: <span id="obstacle-count">0</span></div>
              <div>å»ºå›¾æ—¶é—´: <span id="mapping-time">00:00</span></div>
            </div>
          </div>
          <!-- æ–¹å‘æ§åˆ¶åŒº -->
          <div class="joystick-container">
            <div id="directional-buttons">
              <button class="control-btn" id="btn-rotate-left" title="å·¦æ—‹è½¬">
                <i class="fas fa-undo-alt"></i>
              </button>
              <button
                class="control-btn direction-btn"
                id="btn-forward"
                title="å‰è¿›"
              >
                <i class="fas fa-arrow-up"></i>
              </button>
              <button class="control-btn" id="btn-rotate-right" title="å³æ—‹è½¬">
                <i class="fas fa-redo-alt"></i>
              </button>
              <button
                class="control-btn direction-btn"
                id="btn-left"
                title="å·¦å¹³ç§»"
              >
                <i class="fas fa-arrow-left"></i>
              </button>
              <button class="control-btn" id="btn-stop" title="åœæ­¢">
                <i class="fas fa-stop"></i>
              </button>
              <button
                class="control-btn direction-btn"
                id="btn-right"
                title="å³å¹³ç§»"
              >
                <i class="fas fa-arrow-right"></i>
              </button>
              <button class="control-btn"></button>
              <button
                class="control-btn direction-btn"
                id="btn-back"
                title="åé€€"
              >
                <i class="fas fa-arrow-down"></i>
              </button>
              <button class="control-btn"></button>
            </div>
          </div>

          <!-- é€Ÿåº¦æ§åˆ¶åŒº -->
          <div class="speed-control">
            <h3><i class="fas fa-tachometer-alt"></i> é€Ÿåº¦åˆ†çº§æ§åˆ¶</h3>
            <div class="speed-wrapper">
              <div class="speed-display">
                å½“å‰é€Ÿåº¦: <span class="value" id="current-speed">0.55</span> m/s
              </div>
              <input
                type="range"
                min="0"
                max="100"
                value="50"
                class="speed-slider"
                id="speed-mode-slider"
              />
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-top: 10px;
                "
              >
                <span style="font-size: 0.8rem; color: #3498db">ç²¾å¯†æ¨¡å¼</span>
                <span style="font-size: 0.8rem; color: #27ae60">æ ‡å‡†æ¨¡å¼</span>
                <span style="font-size: 0.8rem; color: #e74c3c">é«˜é€Ÿæ¨¡å¼</span>
              </div>
              <div style="margin-top: 10px; text-align: center">
                <span
                  id="speed-mode-label"
                  style="color: #27ae60; font-weight: bold"
                  >æ ‡å‡†æ¨¡å¼</span
                >
                <span>
                  | æœ€å¤§é€Ÿåº¦: <span id="max-speed-value">0.7</span> m/s</span
                >
              </div>
            </div>
          </div>

          <!-- å®‰å…¨æ§åˆ¶ -->
          <div class="safety-control">
            <h3><i class="fas fa-shield-alt"></i> å®‰å…¨æ§åˆ¶</h3>
            <div class="emergency-button" id="emergency-stop-btn">ğŸ›‘ æ€¥åœ</div>
            <div class="safety-status">
              <div class="safety-status-item" id="safety-level-item">
                <div>å®‰å…¨çŠ¶æ€</div>
                <div id="safety-level" style="font-weight: bold">æ­£å¸¸</div>
              </div>
              <div class="safety-status-item">
                <div>éšœç¢ç‰©è·ç¦»</div>
                <div id="obstacle-distance" style="font-weight: bold">-- m</div>
              </div>
            </div>
            <div style="margin-top: 15px; text-align: center">
              <button
                onclick="toggleEmergencyStop()"
                id="toggle-emergency-btn"
                style="background: #e74c3c; width: 100%"
              >
                ğŸ”„ åˆ‡æ¢æ€¥åœçŠ¶æ€
              </button>
            </div>
          </div>

          <!-- æ€§èƒ½ç›‘æ§ -->
          <div class="performance-monitor">
            <h3><i class="fas fa-chart-bar"></i> æ€§èƒ½ç›‘æ§</h3>
            <div class="metrics-grid">
              <div class="metric-item">
                <div class="metric-label">ç½‘ç»œå»¶è¿Ÿ</div>
                <div class="metric-value" id="network-latency">0.00 ms</div>
              </div>
              <div class="metric-item">
                <div class="metric-label">è‡ªé€‚åº”æ§åˆ¶</div>
                <div class="metric-value" id="adaptive-control">æœªæ¿€æ´»</div>
              </div>
              <div class="metric-item">
                <div class="metric-label">è½¨è¿¹ç‚¹æ•°</div>
                <div class="metric-value" id="trajectory-points">0</div>
              </div>
              <div class="metric-item">
                <div class="metric-label">æµ‹è¯•åœºæ™¯</div>
                <div class="metric-value" id="test-scenario">æ­£å¸¸</div>
              </div>
            </div>
          </div>

          <!-- æ§åˆ¶ä¼˜åŒ– -->
          <div class="control-optimization">
            <h3><i class="fas fa-cogs"></i> æ§åˆ¶ä¼˜åŒ–</h3>
            <div class="optimization-controls">
              <button onclick="startTrajectoryRecord()" id="btn-start-record">
                <i class="fas fa-record-vinyl"></i> å¼€å§‹è®°å½•
              </button>
              <button
                onclick="stopTrajectoryRecord()"
                id="btn-stop-record"
                disabled
              >
                <i class="fas fa-stop"></i> åœæ­¢è®°å½•
              </button>
            </div>
            <div class="optimization-controls">
              <select
                id="network-test-select"
                style="
                  flex: 2;
                  padding: 8px;
                  background: rgba(10, 25, 47, 0.3);
                  color: white;
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  border-radius: 6px;
                "
              >
                <option value="normal">æ­£å¸¸ç½‘ç»œ</option>
                <option value="latency">é«˜å»¶è¿Ÿæµ‹è¯•</option>
                <option value="loss">é«˜ä¸¢åŒ…æµ‹è¯•</option>
              </select>
              <button onclick="applyNetworkTest()" style="flex: 1">
                <i class="fas fa-bolt"></i> åº”ç”¨
              </button>
            </div>
            <div style="text-align: center; margin-top: 10px">
              <span id="record-status" style="color: #7f8c8d; font-size: 0.9rem"
                >æœªè®°å½•</span
              >
            </div>
          </div>

          <!-- IMUå§¿æ€ä»ªè¡¨ç›˜ -->
          <div class="imu-dashboard">
            <h3><i class="fas fa-chart-line"></i> IMUå§¿æ€ç›‘æ§</h3>
            <div class="imu-container">
              <div class="imu-box">
                <div class="imu-value roll">
                  <span class="label">ROLL</span>
                  <div id="roll-value">0.00Â°</div>
                </div>
              </div>
              <div class="imu-box">
                <div class="imu-value pitch">
                  <span class="label">PITCH</span>
                  <div id="pitch-value">0.00Â°</div>
                </div>
              </div>
              <div class="imu-box">
                <div class="imu-value yaw">
                  <span class="label">YAW</span>
                  <div id="yaw-value">0.00Â°</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ç”µæ± çŠ¶æ€æ˜¾ç¤º -->
          <div class="battery-container">
            <div class="battery-header">
              <i class="fas fa-battery-full"></i>
              <h3>ç”µæ± çŠ¶æ€</h3>
            </div>
            <div class="battery-progress">
              <div class="battery-fill" id="battery-fill" style="width: 72%">
                <div class="battery-percentage">72%</div>
              </div>
            </div>
            <div class="battery-stats">
              <div class="stat-item">
                <div>ç”µå‹</div>
                <div id="battery-voltage">12.4V</div>
              </div>
              <div class="stat-item">
                <div>çŠ¶æ€</div>
                <div id="battery-status">æ”¾ç”µä¸­</div>
              </div>
            </div>
          </div>

          <!-- å®‰å…¨æ—¥å¿— -->
          <div class="safety-logs" id="safety-logs">
            <div class="log-normal">[ç³»ç»Ÿ] å®‰å…¨æ—¥å¿—åˆå§‹åŒ–å®Œæˆ</div>
            <div class="log-normal">[ç³»ç»Ÿ] ç­‰å¾…å®‰å…¨äº‹ä»¶...</div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
      <div class="main-content">
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="map-tab">
            <i class="fas fa-map-marked-alt"></i> SLAMå¯¼èˆªåœ°å›¾
          </button>
          <button class="tab-btn" data-tab="path-planning-tab">
            <i class="fas fa-route"></i> è·¯å¾„è§„åˆ’
          </button>
          <button class="tab-btn" data-tab="task-tab">
            <i class="fas fa-tasks"></i> ä»»åŠ¡ç®¡ç†
          </button>
          <button class="tab-btn" data-tab="system-tab">
            <i class="fas fa-cogs"></i> ç³»ç»Ÿè®¾ç½®
          </button>
        </div>
        <div id="path-planning-tab" class="tab-content">
          <div class="slam-header">
            <h2><i class="fas fa-route"></i> å¤šç›®æ ‡ç‚¹è·¯å¾„è§„åˆ’ç³»ç»Ÿ</h2>
            <div class="map-controls">
              <div class="map-actions">
                <button class="map-control-btn" id="btn-add-waypoint-mode">
                  <i class="fas fa-map-marker-alt"></i> æ·»åŠ è·¯å¾„ç‚¹
                </button>
                <button class="map-control-btn" id="btn-clear-waypoints">
                  <i class="fas fa-trash-alt"></i> æ¸…ç©ºè·¯å¾„ç‚¹
                </button>
                <button class="map-control-btn" id="btn-plan-path">
                  <i class="fas fa-project-diagram"></i> è§„åˆ’è·¯å¾„
                </button>
              </div>

              <div class="map-actions">
                <button class="map-control-btn" id="btn-start-path">
                  <i class="fas fa-play"></i> å¼€å§‹æ‰§è¡Œ
                </button>
                <button class="map-control-btn" id="btn-stop-path">
                  <i class="fas fa-stop"></i> åœæ­¢æ‰§è¡Œ
                </button>
                <button class="map-control-btn" id="btn-export-path">
                  <i class="fas fa-download"></i> å¯¼å‡ºè·¯å¾„
                </button>
              </div>
            </div>
          </div>

          <!-- è·¯å¾„è§„åˆ’åœ°å›¾åŒºåŸŸ -->
          <div class="map-container">
            <canvas id="path-planning-canvas" width="800" height="500"></canvas>
            <div class="map-toolbar">
              <button onclick="pathPlanningSystem.zoomIn()">æ”¾å¤§</button>
              <button onclick="pathPlanningSystem.zoomOut()">ç¼©å°</button>
              <button onclick="pathPlanningSystem.resetView()">é‡ç½®</button>
              <div style="color: white; font-size: 0.8rem; margin-top: 5px">
                ç¼©æ”¾: <span id="path-scale-display">1.00</span>x
              </div>
            </div>
          </div>

          <!-- è·¯å¾„è§„åˆ’æ§åˆ¶é¢æ¿ -->
          <div class="navigation-section">
            <div class="nav-header">
              <h3><i class="fas fa-cogs"></i> è·¯å¾„è§„åˆ’å‚æ•°</h3>
              <div>
                <span>è·¯å¾„ç‚¹æ•°é‡: <span id="waypoint-count">0</span></span>
              </div>
            </div>

            <div class="two-columns" style="gap: 20px; margin-top: 15px">
              <div>
                <h4>ä¼˜åŒ–ç®—æ³•</h4>
                <select
                  id="optimization-method"
                  style="width: 100%; padding: 8px; margin-bottom: 15px"
                >
                  <option value="nearest_neighbor">æœ€è¿‘é‚»ç®—æ³•</option>
                  <option value="genetic_algorithm">é—ä¼ ç®—æ³•</option>
                </select>

                <h4>å¹³æ»‘æ–¹æ³•</h4>
                <select id="smoothing-method" style="width: 100%; padding: 8px">
                  <option value="linear">çº¿æ€§æ’å€¼</option>
                  <option value="bezier">è´å¡å°”æ›²çº¿</option>
                  <option value="cubic_spline" selected>ä¸‰æ¬¡æ ·æ¡</option>
                </select>
              </div>

              <div>
                <h4>æ‰§è¡ŒçŠ¶æ€</h4>
                <div
                  id="path-execution-status"
                  style="
                    background: #2d3748;
                    padding: 10px;
                    border-radius: 5px;
                    margin-bottom: 15px;
                  "
                >
                  <div>çŠ¶æ€: <span style="color: #e74c3c">æœªå¼€å§‹</span></div>
                  <div>
                    è¿›åº¦: <span id="path-progress">0</span>/<span
                      id="path-total"
                      >0</span
                    >
                  </div>
                </div>

                <button
                  class="map-control-btn"
                  id="btn-load-demo"
                  style="width: 100%"
                >
                  <i class="fas fa-magic"></i> åŠ è½½æ¼”ç¤ºè·¯å¾„
                </button>
              </div>
            </div>

            <div class="point-list" style="height: 150px; margin-top: 15px">
              <ul id="path-waypoints-list">
                <div style="text-align: center; color: #7f8c8d; padding: 20px">
                  æš‚æ— è·¯å¾„ç‚¹ï¼Œç‚¹å‡»åœ°å›¾æ·»åŠ è·¯å¾„ç‚¹
                </div>
              </ul>
            </div>
          </div>
        </div>

        <!-- SLAMåœ°å›¾é¡µ -->
        <div id="map-tab" class="tab-content active">
          <!-- SLAMæ ‡é¢˜æ  -->
          <div class="slam-header">
            <h2>
              <i class="fas fa-map-marked-alt"></i> SLAMå®æ—¶å»ºå›¾ä¸ç¯å¢ƒå¯¼èˆª
            </h2>
            <div class="map-controls">
              <div class="map-actions">
                <button class="map-control-btn" id="btn-start-slam">
                  <i class="fas fa-play"></i> å¼€å§‹å»ºå›¾
                </button>
                <button class="map-control-btn" id="btn-stop-slam">
                  <i class="fas fa-stop"></i> åœæ­¢å»ºå›¾
                </button>
                <button class="map-control-btn" id="btn-save-map">
                  <i class="fas fa-save"></i> ä¿å­˜åœ°å›¾
                </button>
              </div>

              <div class="map-actions">
                <button class="map-control-btn" id="btn-rm-points">
                  <i class="fas fa-trash-alt"></i> æ¸…é™¤æ‰€æœ‰ç‚¹
                </button>
                <button class="map-control-btn" id="btn-start-nav">
                  <i class="fas fa-rocket"></i> å¼€å§‹å¯¼èˆª
                </button>
                <button class="map-control-btn" onclick="resetSafetySystem()">
                  <i class="fas fa-redo"></i> é‡ç½®å®‰å…¨
                </button>
              </div>
            </div>
          </div>

          <!-- SLAMåœ°å›¾åŒºåŸŸ -->
          <div class="map-container">
            <canvas id="slam-map-canvas" width="800" height="600"></canvas>
            <div
              id="coordinates-display"
              class="coordinates-display"
              style="display: none"
            ></div>
            <div class="map-toolbar">
              <button onclick="mapSystem.zoomIn()">æ”¾å¤§</button>
              <button onclick="mapSystem.zoomOut()">ç¼©å°</button>
              <button onclick="mapSystem.resetView()">é‡ç½®</button>
              <button onclick="mapSystem.toggleGrid()">ç½‘æ ¼</button>
              <div style="color: white; font-size: 0.8rem; margin-top: 5px">
                ç¼©æ”¾: <span id="scale-display">1.00</span>x
              </div>
            </div>
          </div>

          <!-- å¯¼èˆªç‚¹æ§åˆ¶åŒº -->
          <div class="navigation-section">
            <div class="nav-header">
              <h3><i class="fas fa-location-dot"></i> å¯¼èˆªç‚¹ç®¡ç†</h3>
              <div>
                <button class="map-control-btn" id="btn-show-path">
                  <i class="fas fa-route"></i> æ˜¾ç¤ºè·¯å¾„
                </button>
                <button
                  class="map-control-btn"
                  onclick="mapSystem.saveWaypoints()"
                >
                  <i class="fas fa-save"></i> ä¿å­˜
                </button>
                <button
                  class="map-control-btn"
                  onclick="mapSystem.loadWaypoints()"
                >
                  <i class="fas fa-download"></i> åŠ è½½
                </button>
              </div>
            </div>

            <div class="point-list">
              <ul id="nav-points-list">
                <!-- å¯¼èˆªç‚¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
              </ul>
            </div>
          </div>
        </div>

        <!-- ä»»åŠ¡ç®¡ç†é¡µ -->
        <div id="task-tab" class="tab-content">
          <div class="task-manager">
            <!-- ä»»åŠ¡åˆ›å»ºè¡¨å• -->
            <div class="task-form">
              <div class="form-header">
                <i class="fas fa-plus-circle"></i>
                <h3>åˆ›å»ºæ–°ä»»åŠ¡</h3>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>ä»»åŠ¡ç±»å‹</label>
                  <select id="task-type">
                    <option value="">-- é€‰æ‹©ä»»åŠ¡ç±»å‹ --</option>
                    <option value="charge">å‰å¾€å……ç”µç«™</option>
                    <option value="inspection">å·¡æ£€åŒºåŸŸA</option>
                    <option value="transport">è¿é€ç‰©å“åˆ°B</option>
                    <option value="monitoring">ç¯å¢ƒç›‘æµ‹</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>ç›®æ ‡åæ ‡</label>
                  <input
                    type="text"
                    id="task-coord"
                    placeholder="è¾“å…¥åæ ‡ x,y"
                  />
                </div>

                <div class="form-group">
                  <label>ä¼˜å…ˆçº§</label>
                  <select id="task-priority">
                    <option value="high">é«˜</option>
                    <option value="medium">ä¸­</option>
                    <option value="low" selected>ä½</option>
                  </select>
                </div>
              </div>

              <button class="add-btn" id="btn-add-task">
                <i class="fas fa-plus"></i> æ·»åŠ ä»»åŠ¡
              </button>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="task-list-container">
              <div class="task-list-header">
                <div>ä»»åŠ¡åç§°</div>
                <div>ç±»å‹</div>
                <div>åæ ‡</div>
                <div>ä¼˜å…ˆçº§</div>
                <div>çŠ¶æ€</div>
                <div>æ“ä½œ</div>
              </div>

              <div class="task-list">
                <div class="task-item">
                  <div class="task-id">T-1001 | å‰å¾€å……ç”µç«™</div>
                  <div>å……ç”µ</div>
                  <div>(3.2, 2.5)</div>
                  <div class="priority-high">é«˜</div>
                  <div class="status-in-progress">è¿›è¡Œä¸­</div>
                  <div>
                    <button class="action-btn">
                      <i class="fas fa-check"></i> å®Œæˆ
                    </button>
                    <button class="action-btn">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>

                <div class="task-item">
                  <div class="task-id">T-1002 | å·¡æ£€åŒºåŸŸA</div>
                  <div>å·¡æ£€</div>
                  <div>(5.7, 4.1)</div>
                  <div class="priority-medium">ä¸­</div>
                  <div class="status-pending">å¾…æ‰§è¡Œ</div>
                  <div>
                    <button class="action-btn">
                      <i class="fas fa-play"></i> æ‰§è¡Œ
                    </button>
                    <button class="action-btn">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç³»ç»Ÿè®¾ç½®é¡µ -->
        <div id="system-tab" class="tab-content">
          <div style="padding: 20px; text-align: center">
            <h2 style="margin-bottom: 20px; color: #64b5f6">ç³»ç»Ÿè®¾ç½®</h2>
            <div
              style="
                background: rgba(12, 28, 45, 0.7);
                border-radius: 12px;
                padding: 30px;
              "
            >
              <p style="margin-bottom: 30px; opacity: 0.8">
                é«˜çº§ç³»ç»Ÿè®¾ç½®å°†åœ¨åç»­ç‰ˆæœ¬å¼€æ”¾
              </p>
              <div
                style="
                  font-size: 5rem;
                  color: rgba(100, 181, 246, 0.3);
                  margin-bottom: 30px;
                "
              >
                <i class="fas fa-cogs"></i>
              </div>
              <p>å½“å‰ç³»ç»Ÿç‰ˆæœ¬: v2.5.1</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==================== ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½ ====================

      // Socket.IO è¿æ¥
      const socket = io();

      // ç³»ç»ŸçŠ¶æ€å˜é‡
      let emergencyActive = false;
      let currentSpeedLevel = 2;
      let isRecordingTrajectory = false;
      let trajectoryPoints = [];
      let safetyData = {};
      // SLAMå»ºå›¾æ§åˆ¶åŠŸèƒ½
      let slamMappingActive = false;
      let mappingStartTime = 0;
      let mappingTimer = null;

      // é€Ÿåº¦çº§åˆ«é…ç½®
      const speedLevels = {
        1: { label: "ç²¾å¯†æ¨¡å¼", maxSpeed: 0.3, color: "#3498db" },
        2: { label: "æ ‡å‡†æ¨¡å¼", maxSpeed: 0.7, color: "#27ae60" },
        3: { label: "é«˜é€Ÿæ¨¡å¼", maxSpeed: 1.0, color: "#e74c3c" },
      };

      // ==================== Socket.IO äº‹ä»¶å¤„ç† ====================
      // SocketIO SLAMäº‹ä»¶å¤„ç†
      // SLAMçŠ¶æ€æ›´æ–°
      socket.on("slam_status", function (data) {
        updateSLAMStatus(data);
      });

      socket.on("slam_progress", function (data) {
        updateSlamProgress(data);
      });

      socket.on("slam_event", function (data) {
        handleSLAMEvent(data);
      });
      function updateSLAMStatus(data) {
        slamMappingActive = data.mapping_active;
        const statusElement = document.getElementById("slam-status");
        const startBtn = document.getElementById("btn-start-slam");
        const stopBtn = document.getElementById("btn-stop-slam");

        if (slamMappingActive) {
          statusElement.textContent = "å»ºå›¾ä¸­";
          statusElement.style.color = "#27ae60";
          startBtn.disabled = true;
          stopBtn.disabled = false;

          // å¼€å§‹è®¡æ—¶
          mappingStartTime = Date.now();
          startMappingTimer();

          logSafetyEvent("normal", "[SLAM] å¼€å§‹å®æ—¶å»ºå›¾");
        } else {
          statusElement.textContent = "æœªå¯åŠ¨";
          statusElement.style.color = "#e74c3c";
          startBtn.disabled = false;
          stopBtn.disabled = true;

          // åœæ­¢è®¡æ—¶
          stopMappingTimer();

          logSafetyEvent("normal", "[SLAM] åœæ­¢å»ºå›¾");
        }
      }

      function handleSLAMEvent(data) {
        switch (data.type) {
          case "map_saved":
            logSafetyEvent("normal", `[SLAM] ${data.message}`);
            showNotification("åœ°å›¾ä¿å­˜æˆåŠŸ", "success");
            break;
          case "map_reset":
            logSafetyEvent("warning", `[SLAM] ${data.message}`);
            showNotification("åœ°å›¾å·²é‡ç½®", "warning");
            break;
        }
      }

      function startMappingTimer() {
        if (mappingTimer) {
          clearInterval(mappingTimer);
        }

        mappingTimer = setInterval(() => {
          const elapsed = Math.floor((Date.now() - mappingStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          document.getElementById("mapping-time").textContent = `${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }, 1000);
      }
      function updateSlamProgress(data) {
        if (data.explored_percentage !== undefined) {
          document.getElementById("explored-area").textContent =
            data.explored_percentage.toFixed(1) + "%";
        }
      }

      function stopMappingTimer() {
        if (mappingTimer) {
          clearInterval(mappingTimer);
          mappingTimer = null;
        }
      }

      // SLAMæ§åˆ¶å‡½æ•°
      function startSLAMMapping() {
        socket.emit("start_slam_mapping", {}, function (response) {
          showNotification(
            response.message,
            response.status === "success" ? "success" : "error"
          );
        });
      }

      function stopSLAMMapping() {
        socket.emit("stop_slam_mapping", {}, function (response) {
          showNotification(
            response.message,
            response.status === "success" ? "success" : "error"
          );
        });
      }

      function saveMap() {
        const filename = prompt(
          "è¯·è¾“å…¥åœ°å›¾æ–‡ä»¶å:",
          `map_${new Date().toISOString().slice(0, 19).replace(/:/g, "-")}`
        );
        if (filename) {
          socket.emit(
            "save_slam_map",
            { filename: filename },
            function (response) {
              showNotification(
                response.message,
                response.status === "success" ? "success" : "error"
              );
            }
          );
        }
      }

      function resetMap() {
        if (confirm("ç¡®å®šè¦é‡ç½®åœ°å›¾å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å»ºå›¾æ•°æ®ã€‚")) {
          socket.emit("reset_map");
        }
      }

      // åœ°å›¾æ•°æ®ç»Ÿè®¡æ›´æ–°
      function updateMapStats(mapData) {
        if (!mapData || !mapData.data) return;

        const data = mapData.data;
        let freeCount = 0;
        let occupiedCount = 0;
        let unknownCount = 0;

        for (let value of data) {
          if (value === 0) freeCount++;
          else if (value === 100) occupiedCount++;
          else if (value === -1) unknownCount++;
        }

        const total = data.length;
        const exploredArea = (
          ((freeCount + occupiedCount) / total) *
          100
        ).toFixed(1);

        document.getElementById("explored-area").textContent =
          exploredArea + "%";
        document.getElementById("obstacle-count").textContent = occupiedCount;

        // æ›´æ–°åœ°å›¾å°ºå¯¸æ˜¾ç¤º
        if (mapData.metadata) {
          document.getElementById(
            "map-size"
          ).textContent = `${mapData.metadata.width} x ${mapData.metadata.height}`;
        }
      }

      // åœ¨æ”¶åˆ°åœ°å›¾æ•°æ®æ—¶æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      socket.on("map_data", function (data) {
        updateMapStats(data);
      });
      // è¿æ¥çŠ¶æ€å¤„ç†
      socket.on("connect", () => {
        updateConnectionStatus(
          "ç³»ç»Ÿå·²è¿æ¥ - å»¶è¿Ÿ: 18ms - ç³»ç»ŸçŠ¶æ€: æ­£å¸¸è¿è¡Œ",
          true
        );
        logSafetyEvent("normal", "[ç³»ç»Ÿ] å·²è¿æ¥åˆ°ROS 2æœåŠ¡å™¨");
      });

      socket.on("disconnect", () => {
        updateConnectionStatus("ç³»ç»Ÿè¿æ¥æ–­å¼€ - è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥", false);
        logSafetyEvent("danger", "[ç³»ç»Ÿ] ä¸ROS 2æœåŠ¡å™¨æ–­å¼€è¿æ¥");
      });

      // å®‰å…¨çŠ¶æ€æ›´æ–°
      socket.on("safety_status", (data) => {
        safetyData = data;
        updateSafetyDisplay(data);
      });

      // å®‰å…¨äº‹ä»¶å¤„ç†
      socket.on("safety_event", (data) => {
        handleSafetyEvent(data);
      });

      // å®æ—¶é€Ÿåº¦æ›´æ–°
      socket.on("velocity_data", (data) => {
        document.getElementById("current-speed").textContent = Math.abs(
          data.linear_x
        ).toFixed(2);
      });

      // IMUæ•°æ®æ›´æ–°
      socket.on("imu_data", (data) => {
        document.getElementById("roll-value").textContent =
          ((data.orientation.x * 180) / Math.PI).toFixed(1) + "Â°";
        document.getElementById("pitch-value").textContent =
          ((data.orientation.y * 180) / Math.PI).toFixed(1) + "Â°";
        document.getElementById("yaw-value").textContent =
          ((data.orientation.z * 180) / Math.PI).toFixed(1) + "Â°";
      });

      // ç”µæ± æ•°æ®æ›´æ–°
      socket.on("battery_data", (data) => {
        const percentage = Math.round(data.percentage * 100);
        document.getElementById("battery-fill").style.width = percentage + "%";
        document
          .getElementById("battery-fill")
          .querySelector(".battery-percentage").textContent = percentage + "%";
        document.getElementById("battery-voltage").textContent =
          data.voltage.toFixed(1) + "V";

        let statusText = "æœªçŸ¥";
        if (data.status === 1) statusText = "å……ç”µä¸­";
        else if (data.status === 2) statusText = "æ”¾ç”µä¸­";
        else if (data.status === 3) statusText = "å·²å……æ»¡";
        document.getElementById("battery-status").textContent = statusText;
      });

      // æ€§èƒ½ç›‘æ§æ•°æ®
      socket.on("performance_metrics", (data) => {
        document.getElementById("network-latency").textContent =
          (data.network_latency * 1000).toFixed(1) + " ms";
        document.getElementById("adaptive-control").textContent =
          data.adaptive_control_active ? "æ¿€æ´»" : "æœªæ¿€æ´»";
        document.getElementById("adaptive-control").style.color =
          data.adaptive_control_active ? "#27ae60" : "#7f8c8d";
        document.getElementById("test-scenario").textContent =
          data.network_test_scenario;

        // æ›´æ–°è½¨è¿¹è®°å½•çŠ¶æ€
        if (data.trajectory_recording !== isRecordingTrajectory) {
          isRecordingTrajectory = data.trajectory_recording;
          updateRecordStatus();
        }
      });

      // è½¨è¿¹ç‚¹æ•°æ®
      socket.on("trajectory_point", (data) => {
        trajectoryPoints.push(data);
        document.getElementById("trajectory-points").textContent =
          trajectoryPoints.length;
      });

      // æ§åˆ¶äº‹ä»¶
      socket.on("control_event", (data) => {
        switch (data.type) {
          case "trajectory_record":
            logSafetyEvent(
              data.activated ? "warning" : "normal",
              `[è½¨è¿¹è®°å½•] ${data.message}`
            );
            break;
          case "network_test":
            logSafetyEvent("normal", `[ç½‘ç»œæµ‹è¯•] ${data.message}`);
            break;
        }
      });

      // å‘½ä»¤å“åº”
      socket.on("command_response", (data) => {
        // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºå‘½ä»¤å“åº”æ¶ˆæ¯
        console.log("å‘½ä»¤å“åº”:", data);
      });

      // åœ°å›¾æ•°æ®
      socket.on("map_data", (data) => {
        console.log("ğŸ“¨ Socketæ”¶åˆ°åœ°å›¾æ•°æ®ï¼", data);
        console.log(
          "æ•°æ®å°ºå¯¸:",
          data.metadata.width,
          "x",
          data.metadata.height
        );

        if (mapSystem) {
          console.log("ğŸ”„ è®¾ç½®åœ°å›¾æ•°æ®åˆ°mapSystem...");
          mapSystem.state.mapData = data;
          mapSystem.updateMapParameters(data.metadata);
          mapSystem.centerMap();
          mapSystem.render();
          console.log("âœ… åœ°å›¾æ•°æ®è®¾ç½®å®Œæˆï¼ŒmapData:", mapSystem.state.mapData);
        } else {
          console.log("âŒ mapSystemæœªåˆå§‹åŒ–ï¼Œæ— æ³•è®¾ç½®æ•°æ®");
        }
      });

      // å¯¼èˆªç‚¹æ•°æ®
      socket.on("waypoints_data", (data) => {
        if (mapSystem) {
          mapSystem.waypoints = data;
          mapSystem.render();
          mapSystem.updateWaypointList();
        }
      });
      // åæ ‡è½¬æ¢ç»“æœå¤„ç†
      socket.on("waypoint_added_with_coords", (data) => {
        console.log("âœ… å¯¼èˆªç‚¹æ·»åŠ æˆåŠŸ:", data);

        if (mapSystem) {
          // åœ¨åç«¯å·²ç»æ·»åŠ äº†å¯¼èˆªç‚¹ï¼Œè¿™é‡Œåªéœ€è¦æ›´æ–°æ˜¾ç¤º
          mapSystem.waypoints.push(data.waypoint);
          mapSystem.render();
          mapSystem.updateWaypointList();
        }
      });

      // åæ ‡è½¬æ¢æµ‹è¯•ç»“æœ
      socket.on("coordinate_test_result", (data) => {
        console.log("ğŸ§ª åæ ‡è½¬æ¢æµ‹è¯•:", data);
      });

      // åæ ‡è½¬æ¢ç»“æœ
      socket.on("coordinate_conversion_result", (data) => {
        console.log("ğŸ”„ åæ ‡è½¬æ¢:", data);
      });
      // ==================== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ====================

      function updateConnectionStatus(message, connected) {
        document.getElementById("connection-text").textContent = message;
        const dot = document.getElementById("status-dot");
        if (connected) {
          dot.style.background = "#00c853";
          dot.style.boxShadow = "0 0 10px #00c853";
        } else {
          dot.style.background = "#ff4444";
          dot.style.boxShadow = "0 0 10px #ff4444";
        }
      }

      function updateSafetyDisplay(data) {
        // æ›´æ–°å®‰å…¨çŠ¶æ€
        const safetyLevels = ["æ­£å¸¸", "è­¦å‘Š", "å±é™©", "ç´§æ€¥"];
        const safetyLevelElement = document.getElementById("safety-level");
        const safetyLevelItem = document.getElementById("safety-level-item");

        safetyLevelElement.textContent = safetyLevels[data.safety_level];
        safetyLevelItem.className =
          "safety-status-item safety-level-" +
          ["normal", "warning", "danger", "emergency"][data.safety_level];

        // æ›´æ–°éšœç¢ç‰©è·ç¦»
        document.getElementById("obstacle-distance").textContent =
          data.obstacle_distance.toFixed(2) + " m";

        // æ›´æ–°ç´§æ€¥åœæ­¢æŒ‰é’®çŠ¶æ€
        updateEmergencyButton(data.emergency_stop);
      }

      function handleSafetyEvent(data) {
        switch (data.type) {
          case "emergency_stop":
            logSafetyEvent(
              data.activated ? "emergency" : "normal",
              `[ç´§æ€¥åœæ­¢] ${data.message}`
            );
            break;
          case "speed_level_change":
            logSafetyEvent("normal", `[é€Ÿåº¦æ§åˆ¶] ${data.message}`);
            break;
          case "system_reset":
            logSafetyEvent("normal", `[ç³»ç»Ÿ] ${data.message}`);
            break;
          default:
            logSafetyEvent("normal", `[äº‹ä»¶] ${data.message}`);
        }
      }

      function logSafetyEvent(level, message) {
        const logElement = document.getElementById("safety-logs");
        const timestamp = new Date().toLocaleTimeString();

        const logEntry = document.createElement("div");
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logEntry.className = `log-${level}`;

        logElement.prepend(logEntry);

        // æœ€å¤šä¿ç•™20æ¡æ—¥å¿—
        if (logElement.children.length > 20) {
          logElement.removeChild(logElement.lastChild);
        }
      }

      // ==================== æ§åˆ¶åŠŸèƒ½ ====================

      function sendControlCommand(linear_x, angular_z) {
        socket.emit("control_command", {
          linear_x: linear_x,
          angular_z: angular_z,
        });
      }

      function toggleEmergencyStop() {
        emergencyActive = !emergencyActive;
        socket.emit("emergency_stop", { activate: emergencyActive });
      }

      function updateEmergencyButton(isActive) {
        emergencyActive = isActive;
        const btn = document.getElementById("emergency-stop-btn");
        const toggleBtn = document.getElementById("toggle-emergency-btn");

        if (isActive) {
          btn.innerHTML = "ğŸš¨<br>æ€¥åœæ¿€æ´»";
          btn.classList.add("active");
          toggleBtn.innerHTML = "ğŸ”„ è§£é™¤æ€¥åœ";
          toggleBtn.style.background = "#27ae60";
        } else {
          btn.innerHTML = "ğŸ›‘<br>æ€¥åœ";
          btn.classList.remove("active");
          toggleBtn.innerHTML = "ğŸ”„ æ¿€æ´»æ€¥åœ";
          toggleBtn.style.background = "#e74c3c";
        }
      }

      function resetSafetySystem() {
        socket.emit("reset_safety_system");
        logSafetyEvent("normal", "[ç³»ç»Ÿ] å®‰å…¨ç³»ç»Ÿé‡ç½®è¯·æ±‚å·²å‘é€");
      }

      // ==================== é€Ÿåº¦æ§åˆ¶åŠŸèƒ½ ====================

      const speedSlider = document.getElementById("speed-mode-slider");

      speedSlider.addEventListener("input", updateSpeedLevel);

      function updateSpeedLevel() {
        const value = parseInt(speedSlider.value);
        let selectedLevel;

        if (value < 35) {
          selectedLevel = 1; // ç²¾å¯†æ¨¡å¼
        } else if (value < 65) {
          selectedLevel = 2; // æ ‡å‡†æ¨¡å¼
        } else {
          selectedLevel = 3; // é«˜é€Ÿæ¨¡å¼
        }

        if (currentSpeedLevel !== selectedLevel) {
          currentSpeedLevel = selectedLevel;
          const levelConfig = speedLevels[selectedLevel];

          // æ›´æ–°ç•Œé¢æ˜¾ç¤º
          document.getElementById("speed-mode-label").textContent =
            levelConfig.label;
          document.getElementById("speed-mode-label").style.color =
            levelConfig.color;
          document.getElementById("max-speed-value").textContent =
            levelConfig.maxSpeed.toFixed(1);

          // å‘é€åˆ°åç«¯
          socket.emit("set_speed_level", { level: selectedLevel });
        }
      }

      // ==================== è½¨è¿¹è®°å½•åŠŸèƒ½ ====================

      function startTrajectoryRecord() {
        socket.emit("start_trajectory_record");
        isRecordingTrajectory = true;
        updateRecordStatus();
      }

      function stopTrajectoryRecord() {
        socket.emit("stop_trajectory_record");
        isRecordingTrajectory = false;
        updateRecordStatus();
      }

      function updateRecordStatus() {
        const statusElement = document.getElementById("record-status");
        const startBtn = document.getElementById("btn-start-record");
        const stopBtn = document.getElementById("btn-stop-record");

        if (isRecordingTrajectory) {
          statusElement.textContent = "è®°å½•ä¸­...";
          statusElement.style.color = "#e74c3c";
          startBtn.disabled = true;
          stopBtn.disabled = false;
        } else {
          statusElement.textContent = "æœªè®°å½•";
          statusElement.style.color = "#7f8c8d";
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }
      }

      // ==================== ç½‘ç»œæµ‹è¯•åŠŸèƒ½ ====================

      function applyNetworkTest() {
        const scenario = document.getElementById("network-test-select").value;
        socket.emit("set_network_test", { scenario: scenario });
      }

      function resetAdaptiveController() {
        socket.emit("reset_adaptive_controller");
      }

      // ==================== è¿åŠ¨æ§åˆ¶äº‹ä»¶ ====================

      const btnForward = document.getElementById("btn-forward");
      const btnBack = document.getElementById("btn-back");
      const btnLeft = document.getElementById("btn-left");
      const btnRight = document.getElementById("btn-right");
      const btnRotateLeft = document.getElementById("btn-rotate-left");
      const btnRotateRight = document.getElementById("btn-rotate-right");
      const btnStop = document.getElementById("btn-stop");

      // æŒ‰é’®æŒ‰ä¸‹äº‹ä»¶
      btnForward.addEventListener("mousedown", () =>
        sendControlCommand(0.5, 0)
      );
      btnBack.addEventListener("mousedown", () => sendControlCommand(-0.5, 0));
      btnLeft.addEventListener("mousedown", () => sendControlCommand(0, 0.5));
      btnRight.addEventListener("mousedown", () => sendControlCommand(0, -0.5));
      btnRotateLeft.addEventListener("mousedown", () =>
        sendControlCommand(0, 1.0)
      );
      btnRotateRight.addEventListener("mousedown", () =>
        sendControlCommand(0, -1.0)
      );
      btnStop.addEventListener("click", () => sendControlCommand(0, 0));

      // æŒ‰é’®é‡Šæ”¾äº‹ä»¶
      document.querySelectorAll(".control-btn").forEach((btn) => {
        btn.addEventListener("mouseup", () => sendControlCommand(0, 0));
        btn.addEventListener("mouseleave", () => sendControlCommand(0, 0));
      });

      // ==================== åœ°å›¾äº¤äº’ç³»ç»Ÿ ====================
      class MapInteraction {
        constructor(canvasId) {
          this.canvas = document.getElementById(canvasId);
          this.ctx = this.canvas.getContext("2d");

          // åˆå§‹çŠ¶æ€
          this.state = {
            mapData: null,
            scale: 1.0,
            offset: { x: 0, y: 0 }, // ä¿®å¤ï¼šä»0å¼€å§‹
            mapOrigin: { x: -10, y: -10 }, // æ ¹æ®ä½ çš„åœ°å›¾è®¾ç½®
            resolution: 0.05,
            width: 384,
            height: 384,
            isDragging: false,
            startDragPos: { x: 0, y: 0 },
            startDragOffset: { x: 0, y: 0 },
          };

          this.waypoints = [];

          // ğŸ¯ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ç®­å¤´å‡½æ•°ç»‘å®šæ‰€æœ‰æ–¹æ³•
          this.handleZoom = (e) => {
            e.preventDefault();

            const rect = this.canvas.getBoundingClientRect();
            const screenX = e.clientX - rect.left;
            const screenY = e.clientY - rect.top;

            const mouseWorldPos = this.screenToWorld(screenX, screenY);

            const scaleFactor = 0.1;
            const oldScale = this.state.scale;
            const newScale = Math.max(
              0.1,
              Math.min(
                10.0,
                oldScale * (1 + (e.deltaY > 0 ? -scaleFactor : scaleFactor))
              )
            );

            const newScreenX =
              ((mouseWorldPos.x - this.state.mapOrigin.x) /
                this.state.resolution) *
                newScale +
              this.state.offset.x;
            const newScreenY =
              this.state.height -
              ((mouseWorldPos.y - this.state.mapOrigin.y) /
                this.state.resolution) *
                newScale +
              this.state.offset.y;

            this.state.offset.x -= screenX - newScreenX;
            this.state.offset.y -= screenY - newScreenY;

            this.state.scale = newScale;
            document.getElementById("scale-display").textContent =
              newScale.toFixed(2);
            this.render();
          };

          this.startDrag = (e) => {
            if (e.button === 0) {
              this.state.isDragging = true;
              this.state.startDragPos = { x: e.clientX, y: e.clientY };
              this.state.startDragOffset = { ...this.state.offset };
              this.canvas.style.cursor = "grabbing";
            }
          };

          this.handleDrag = (e) => {
            if (!this.state.isDragging) return;

            const deltaX = e.clientX - this.state.startDragPos.x;
            const deltaY = e.clientY - this.state.startDragPos.y;

            this.state.offset.x = this.state.startDragOffset.x + deltaX;
            this.state.offset.y = this.state.startDragOffset.y + deltaY;

            this.render();
          };

          this.endDrag = () => {
            this.state.isDragging = false;
            this.canvas.style.cursor = "crosshair";
          };

          this.handleWaypointPlacement = (e) => {
            e.preventDefault();

            const rect = this.canvas.getBoundingClientRect();
            const screenX = e.clientX - rect.left;
            const screenY = e.clientY - rect.top;

            console.log("ğŸ–±ï¸ é¼ æ ‡ç‚¹å‡»ä½ç½®:", { screenX, screenY });

            // ğŸ¯ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„å¸¦åæ ‡è½¬æ¢çš„äº‹ä»¶
            socket.emit("add_waypoint_with_conversion", {
              x: screenX,
              y: screenY,
              label: `ç‚¹${this.waypoints.length + 1}`,
              color: this.getRandomColor(),
            });

            console.log("ğŸ“ å‘é€åæ ‡è½¬æ¢è¯·æ±‚åˆ°åç«¯");
          };

          this.updateCoordinateDisplay = (e) => {
            const rect = this.canvas.getBoundingClientRect();
            const screenX = e.clientX - rect.left;
            const screenY = e.clientY - rect.top;

            const worldPos = this.screenToWorld(screenX, screenY);

            const display = document.getElementById("coordinates-display");
            if (display) {
              display.style.display = "block";
              display.style.left = e.clientX + 10 + "px";
              display.style.top = e.clientY + 10 + "px";
              display.textContent = `ä¸–ç•Œåæ ‡: (${worldPos.x.toFixed(
                2
              )}, ${worldPos.y.toFixed(2)})`;
            }
          };

          this.hideCoordinateDisplay = () => {
            const display = document.getElementById("coordinates-display");
            if (display) {
              display.style.display = "none";
            }
          };

          this.updateWaypointList = () => {
            const listElement = document.getElementById("nav-points-list");
            if (!listElement) {
              console.log("âŒ æ‰¾ä¸åˆ°å¯¼èˆªç‚¹åˆ—è¡¨å…ƒç´ ");
              return;
            }

            if (this.waypoints.length === 0) {
              listElement.innerHTML =
                '<div style="text-align: center; color: #7f8c8d; padding: 20px;">æš‚æ— å¯¼èˆªç‚¹ï¼Œå³é”®ç‚¹å‡»åœ°å›¾æ·»åŠ </div>';
              return;
            }

            listElement.innerHTML = this.waypoints
              .map(
                (wp) => `
                        <li>
                            <div class="point-info">
                                <div><strong>${wp.label}</strong></div>
                                <div>(${wp.x.toFixed(2)}, ${wp.y.toFixed(
                  2
                )})</div>
                            </div>
                            <div class="point-actions">
                                <button onclick="mapSystem.deleteWaypoint(${
                                  wp.id
                                })"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </li>
                    `
              )
              .join("");
          };

          // è®¾ç½®ç›‘å¬å™¨
          this.setupListeners();

          // åˆå§‹å±…ä¸­
          this.centerMap();
          this.render();
        }

        setupListeners() {
          // ä½¿ç”¨å·²ç»ç»‘å®šçš„æ–¹æ³•
          this.canvas.addEventListener("wheel", this.handleZoom);
          this.canvas.addEventListener("mousedown", this.startDrag);
          this.canvas.addEventListener("mousemove", this.handleDrag);
          this.canvas.addEventListener("mouseup", this.endDrag);
          this.canvas.addEventListener("mouseleave", this.endDrag);
          this.canvas.addEventListener(
            "contextmenu",
            this.handleWaypointPlacement
          );
          this.canvas.addEventListener(
            "mousemove",
            this.updateCoordinateDisplay
          );
          this.canvas.addEventListener(
            "mouseleave",
            this.hideCoordinateDisplay
          );
        }

        // å…¶ä»–æ–¹æ³•...
        updateMapParameters(metadata) {
          this.state.width = metadata.width;
          this.state.height = metadata.height;
          this.state.resolution = metadata.resolution;
          this.state.mapOrigin.x = metadata.origin.x;
          this.state.mapOrigin.y = metadata.origin.y;

          console.log("ğŸ“ åœ°å›¾å‚æ•°å·²æ›´æ–°:", {
            width: this.state.width,
            height: this.state.height,
            resolution: this.state.resolution,
            origin: this.state.mapOrigin,
          });

          // é‡æ–°å±…ä¸­
          this.centerMap();
        }

        centerMap() {
          if (!this.state.mapData) {
            // å¦‚æœæ²¡æœ‰åœ°å›¾æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å‚æ•°å±…ä¸­
            const mapWidthPixels =
              this.state.width * this.state.resolution * this.state.scale;
            const mapHeightPixels =
              this.state.height * this.state.resolution * this.state.scale;
            this.state.offset.x = (this.canvas.width - mapWidthPixels) / 2;
            this.state.offset.y = (this.canvas.height - mapHeightPixels) / 2;
          } else {
            // æœ‰åœ°å›¾æ•°æ®æ—¶ä½¿ç”¨å®é™…å‚æ•°
            const metadata = this.state.mapData.metadata;
            const mapWidthPixels =
              metadata.width * metadata.resolution * this.state.scale;
            const mapHeightPixels =
              metadata.height * metadata.resolution * this.state.scale;
            this.state.offset.x = (this.canvas.width - mapWidthPixels) / 2;
            this.state.offset.y = (this.canvas.height - mapHeightPixels) / 2;
          }
          console.log("ğŸ¯ åœ°å›¾å·²å±…ä¸­ï¼Œåç§»é‡:", this.state.offset);
        }

        screenToWorld(screenX, screenY) {
          if (!this.state.mapData) {
            console.log("âš ï¸ æ— åœ°å›¾æ•°æ®ï¼Œä½¿ç”¨ç®€åŒ–è½¬æ¢");
            return { x: screenX, y: screenY };
          }

          const metadata = this.state.mapData.metadata;

          // è½¬æ¢ä¸ºåœ°å›¾åƒç´ åæ ‡
          const pixelX = (screenX - this.state.offset.x) / this.state.scale;
          const pixelY = (screenY - this.state.offset.y) / this.state.scale;

          // è½¬æ¢ä¸ºä¸–ç•Œåæ ‡ï¼ˆYè½´ç¿»è½¬ï¼‰
          const worldX = metadata.origin.x + pixelX * metadata.resolution;
          const worldY =
            metadata.origin.y +
            (metadata.height - pixelY) * metadata.resolution;

          console.log(
            `ğŸ”„ åæ ‡è½¬æ¢: å±å¹•(${screenX}, ${screenY}) â†’ ä¸–ç•Œ(${worldX.toFixed(
              3
            )}, ${worldY.toFixed(3)})`
          );

          return { x: worldX, y: worldY };
        }

        worldToScreen(worldX, worldY) {
          if (!this.state.mapData) {
            return { x: worldX, y: worldY };
          }

          const metadata = this.state.mapData.metadata;

          // è½¬æ¢ä¸ºåœ°å›¾åƒç´ åæ ‡
          const pixelX = (worldX - metadata.origin.x) / metadata.resolution;
          const pixelY =
            metadata.height -
            (worldY - metadata.origin.y) / metadata.resolution;

          // è½¬æ¢ä¸ºå±å¹•åæ ‡
          const screenX = pixelX * this.state.scale + this.state.offset.x;
          const screenY = pixelY * this.state.scale + this.state.offset.y;

          return { x: screenX, y: screenY };
        }

        addWaypoint(x, y, label = "") {
          const waypoint = {
            id: Date.now(),
            x: x,
            y: y,
            label: label,
            color: this.getRandomColor(),
            timestamp: Date.now(),
          };

          this.waypoints.push(waypoint);
          this.updateWaypointList(); // ç°åœ¨è¿™ä¸ªæ–¹æ³•å·²ç»æ­£ç¡®ç»‘å®šäº†

          console.log("ğŸ“ æ·»åŠ å¯¼èˆªç‚¹:", waypoint);

          return waypoint;
        }

        deleteWaypoint(id) {
          this.waypoints = this.waypoints.filter((wp) => wp.id !== id);
          this.render();
          this.updateWaypointList();
          console.log("ğŸ—‘ï¸ åˆ é™¤å¯¼èˆªç‚¹:", id);
        }

        getRandomColor() {
          const colors = [
            "#e74c3c",
            "#3498db",
            "#2ecc71",
            "#9b59b6",
            "#f39c12",
          ];
          return colors[this.waypoints.length % colors.length];
        }
        drawMapBoundaries() {
          if (!this.state.mapData) return;

          const metadata = this.state.mapData.metadata;

          // è®¡ç®—åœ°å›¾è¾¹ç•Œçš„ä¸–ç•Œåæ ‡
          const left = metadata.origin.x;
          const bottom = metadata.origin.y;
          const right = left + metadata.width * metadata.resolution;
          const top = bottom + metadata.height * metadata.resolution;

          // è½¬æ¢ä¸ºå±å¹•åæ ‡
          const corners = [
            this.worldToScreen(left, bottom), // å·¦ä¸‹
            this.worldToScreen(right, bottom), // å³ä¸‹
            this.worldToScreen(right, top), // å³ä¸Š
            this.worldToScreen(left, top), // å·¦ä¸Š
          ];

          // ç»˜åˆ¶è¾¹ç•Œæ¡†
          this.ctx.strokeStyle = "#00ff00";
          this.ctx.lineWidth = 2;
          this.ctx.beginPath();
          this.ctx.moveTo(corners[0].x, corners[0].y);
          this.ctx.lineTo(corners[1].x, corners[1].y);
          this.ctx.lineTo(corners[2].x, corners[2].y);
          this.ctx.lineTo(corners[3].x, corners[3].y);
          this.ctx.closePath();
          this.ctx.stroke();

          console.log(
            `ğŸ“ åœ°å›¾è¾¹ç•Œ: ä¸–ç•Œ[(${left},${bottom}) to (${right},${top})]`
          );
        }
        render() {
          console.log("ğŸ¨ å¼€å§‹æ¸²æŸ“åœ°å›¾...");
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

          if (this.state.mapData) {
            console.log("ğŸ“Š æ¸²æŸ“çœŸå®åœ°å›¾æ•°æ®");
            this.drawMap();
          } else {
            console.log("â³ æ¸²æŸ“å ä½ç¬¦");
            this.drawPlaceholder();
          }

          this.drawCoordinateSystem();
          this.drawWaypoints();
          this.drawDebugInfo();
          this.drawMapBoundaries();
          console.log("âœ… æ¸²æŸ“å®Œæˆ");
        }

        drawMap() {
          console.log("ğŸ–¼ï¸ ç»˜åˆ¶åœ°å›¾æ•°æ®...");

          // æ¸…ç©ºç”»å¸ƒ
          this.ctx.fillStyle = "#0f1f38";
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

          if (!this.state.mapData || !this.state.mapData.data) {
            console.log("âŒ æ²¡æœ‰åœ°å›¾æ•°æ®");
            return;
          }

          const data = this.state.mapData.data;
          const width = this.state.mapData.metadata.width;
          const height = this.state.mapData.metadata.height;

          console.log(
            `ğŸ—ºï¸ åœ°å›¾æ•°æ®: ${width}x${height}, æ•°æ®é•¿åº¦: ${data.length}`
          );

          // ç»˜åˆ¶æ¯ä¸ªç½‘æ ¼
          for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
              const value = data[y * width + x];

              // è®¾ç½®é¢œè‰²
              if (value === 100) {
                this.ctx.fillStyle = "#000000"; // éšœç¢ç‰© - é»‘è‰²
              } else if (value === 0) {
                this.ctx.fillStyle = "#ffffff"; // è‡ªç”±ç©ºé—´ - ç™½è‰²
              } else if (value === -1) {
                this.ctx.fillStyle = "#888888"; // æœªçŸ¥åŒºåŸŸ - ç°è‰²
              } else {
                this.ctx.fillStyle = "#444444"; // å…¶ä»– - æ·±ç°
              }

              // è®¡ç®—å±å¹•ä½ç½®
              const worldX = this.state.mapOrigin.x + x * this.state.resolution;
              const worldY = this.state.mapOrigin.y + y * this.state.resolution;
              const screenPos = this.worldToScreen(worldX, worldY);

              // ç»˜åˆ¶ç½‘æ ¼ï¼ˆè€ƒè™‘ç¼©æ”¾ï¼‰
              const cellSize = this.state.resolution * this.state.scale;
              if (cellSize > 1) {
                // åªåœ¨è¶³å¤Ÿå¤§æ—¶ç»˜åˆ¶
                this.ctx.fillRect(screenPos.x, screenPos.y, cellSize, cellSize);
              }
            }
          }

          console.log("âœ… åœ°å›¾ç»˜åˆ¶å®Œæˆ");
        }

        drawGrid() {
          this.ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
          this.ctx.lineWidth = 1;

          for (
            let x = Math.floor(this.state.mapOrigin.x);
            x <=
            this.state.mapOrigin.x + this.state.width * this.state.resolution;
            x += 1.0
          ) {
            for (
              let y = Math.floor(this.state.mapOrigin.y);
              y <=
              this.state.mapOrigin.y +
                this.state.height * this.state.resolution;
              y += 1.0
            ) {
              const screenPos = this.worldToScreen(x, y);

              this.ctx.beginPath();
              this.ctx.arc(screenPos.x, screenPos.y, 2, 0, Math.PI * 2);
              this.ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
              this.ctx.fill();

              if (x % 2 === 0 && y % 2 === 0) {
                this.ctx.fillStyle = "white";
                this.ctx.font = "10px Arial";
                this.ctx.fillText(
                  `(${x},${y})`,
                  screenPos.x + 5,
                  screenPos.y - 5
                );
              }
            }
          }
        }

        drawWaypoints() {
          this.waypoints.forEach((wp) => {
            const screenPos = this.worldToScreen(wp.x, wp.y);

            this.ctx.fillStyle = wp.color;
            this.ctx.beginPath();
            this.ctx.arc(screenPos.x, screenPos.y, 8, 0, Math.PI * 2);
            this.ctx.fill();

            this.ctx.strokeStyle = "#ffffff";
            this.ctx.lineWidth = 2;
            this.ctx.stroke();

            this.ctx.fillStyle = "#ffffff";
            this.ctx.font = "12px Arial";
            this.ctx.fillText(wp.label, screenPos.x + 12, screenPos.y - 8);
          });
        }

        drawCoordinateSystem() {
          // ç»˜åˆ¶åæ ‡è½´
          this.ctx.strokeStyle = "#4299e1";
          this.ctx.lineWidth = 2;

          // Xè½´
          const originScreen = this.worldToScreen(0, 0);
          this.ctx.beginPath();
          this.ctx.moveTo(originScreen.x, originScreen.y);
          this.ctx.lineTo(originScreen.x + 100, originScreen.y);
          this.ctx.stroke();

          // Yè½´
          this.ctx.beginPath();
          this.ctx.moveTo(originScreen.x, originScreen.y);
          this.ctx.lineTo(originScreen.x, originScreen.y - 100);
          this.ctx.stroke();
        }

        drawDebugInfo() {
          this.ctx.fillStyle = "white";
          this.ctx.font = "12px Arial";
          this.ctx.fillText(
            `åœ°å›¾åŸç‚¹: (${this.state.mapOrigin.x.toFixed(
              2
            )}, ${this.state.mapOrigin.y.toFixed(2)})`,
            10,
            20
          );
          this.ctx.fillText(`åˆ†è¾¨ç‡: ${this.state.resolution}`, 10, 35);
          this.ctx.fillText(
            `å°ºå¯¸: ${this.state.width} x ${this.state.height}`,
            10,
            50
          );
          this.ctx.fillText(`å¯¼èˆªç‚¹æ•°é‡: ${this.waypoints.length}`, 10, 65);
          this.ctx.fillText(
            `åæ ‡è½¬æ¢: ${this.state.mapData ? "å·²åŠ è½½" : "ç­‰å¾…æ•°æ®"}`,
            10,
            80
          );
        }

        drawPlaceholder() {
          this.ctx.fillStyle = "#0f1f38";
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

          this.ctx.fillStyle = "#4a5568";
          this.ctx.font = "20px Arial";
          this.ctx.textAlign = "center";
          this.ctx.fillText(
            "ç­‰å¾…åœ°å›¾æ•°æ®...",
            this.canvas.width / 2,
            this.canvas.height / 2
          );
        }

        zoomIn() {
          this.state.scale = Math.min(10.0, this.state.scale * 1.2);
          document.getElementById("scale-display").textContent =
            this.state.scale.toFixed(2);
          this.render();
        }

        zoomOut() {
          this.state.scale = Math.max(0.1, this.state.scale / 1.2);
          document.getElementById("scale-display").textContent =
            this.state.scale.toFixed(2);
          this.render();
        }

        resetView() {
          this.state.scale = 1.0;
          this.centerMap();
          document.getElementById("scale-display").textContent = "1.00";
          this.render();
        }

        toggleGrid() {
          this.render();
        }
      }

      // ==================== å…¨å±€å˜é‡å’Œåˆå§‹åŒ– ====================

      let mapSystem;

      // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
      const tabBtns = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");

      tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          // ç§»é™¤æ‰€æœ‰æ´»åŠ¨æ ‡ç­¾
          tabBtns.forEach((b) => b.classList.remove("active"));
          tabContents.forEach((c) => c.classList.remove("active"));

          // æ·»åŠ å½“å‰æ´»åŠ¨æ ‡ç­¾
          btn.classList.add("active");
          const tabId = btn.getAttribute("data-tab");
          document.getElementById(tabId).classList.add("active");
        });
      });

      // SLAMæ§åˆ¶
      document
        .getElementById("btn-start-slam")
        .addEventListener("click", () => {
          alert("SLAMå»ºå›¾å·²å¯åŠ¨ï¼å¼€å§‹æ„å»ºç¯å¢ƒåœ°å›¾");
        });

      document.getElementById("btn-start-nav").addEventListener("click", () => {
        alert("å¼€å§‹å¯¼èˆªï¼æœºå™¨äººå°†æŒ‰è®¡åˆ’è·¯çº¿ç§»åŠ¨");
      });

      document.getElementById("btn-save-map").addEventListener("click", () => {
        alert("åœ°å›¾æ•°æ®å·²æˆåŠŸä¿å­˜ï¼");
      });

      // æ¸…é™¤æ‰€æœ‰å¯¼èˆªç‚¹
      document
        .getElementById("btn-rm-points")
        .addEventListener("click", function () {
          if (mapSystem) {
            mapSystem.clearWaypoints();
          }
        });

      // æ·»åŠ ä»»åŠ¡åŠŸèƒ½
      document
        .getElementById("btn-add-task")
        .addEventListener("click", function () {
          const taskType = document.getElementById("task-type").value;
          const taskCoord = document.getElementById("task-coord").value;
          const taskPriority = document.getElementById("task-priority").value;

          if (!taskType) {
            alert("è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹");
            return;
          }

          if (!taskCoord) {
            alert("è¯·è¾“å…¥ç›®æ ‡åæ ‡");
            return;
          }

          const taskTypes = {
            charge: "å……ç”µ",
            inspection: "å·¡æ£€",
            transport: "è¿è¾“",
            monitoring: "ç›‘æµ‹",
          };

          const taskNames = {
            charge: "å‰å¾€å……ç”µç«™",
            inspection: "å·¡æ£€åŒºåŸŸA",
            transport: "è¿é€ç‰©å“åˆ°B",
            monitoring: "ç¯å¢ƒç›‘æµ‹",
          };

          const priorityClasses = {
            high: "priority-high",
            medium: "priority-medium",
            low: "priority-low",
          };

          // åˆ›å»ºæ–°ä»»åŠ¡é¡¹
          const taskList = document.querySelector(".task-list");
          const taskItem = document.createElement("div");
          taskItem.className = "task-item";
          taskItem.innerHTML = `
                <div class="task-id">T-${
                  1000 + (mapSystem ? mapSystem.waypoints.length : 0)
                } | ${taskNames[taskType]}</div>
                <div>${taskTypes[taskType]}</div>
                <div>${taskCoord}</div>
                <div class="${priorityClasses[taskPriority]}">${
            taskPriority === "high"
              ? "é«˜"
              : taskPriority === "medium"
              ? "ä¸­"
              : "ä½"
          }</div>
                <div class="status-pending">å¾…æ‰§è¡Œ</div>
                <div>
                    <button class="action-btn"><i class="fas fa-play"></i> æ‰§è¡Œ</button>
                    <button class="action-btn"><i class="fas fa-trash"></i></button>
                </div>
            `;

          taskList.appendChild(taskItem);

          // é‡ç½®è¡¨å•
          document.getElementById("task-coord").value = "";
          document.getElementById("task-priority").value = "low";

          alert("ä»»åŠ¡æ·»åŠ æˆåŠŸï¼");
        });

      // æŒ‰é”®äº‹ä»¶
      document.addEventListener("keydown", (e) => {
        switch (e.key) {
          case "w":
          case "ArrowUp":
            btnForward.classList.add("active");
            sendControlCommand(0.5, 0);
            break;
          case "s":
          case "ArrowDown":
            btnBack.classList.add("active");
            sendControlCommand(-0.5, 0);
            break;
          case "a":
          case "ArrowLeft":
            btnLeft.classList.add("active");
            sendControlCommand(0, 0.5);
            break;
          case "d":
          case "ArrowRight":
            btnRight.classList.add("active");
            sendControlCommand(0, -0.5);
            break;
          case "q":
            btnRotateLeft.classList.add("active");
            sendControlCommand(0, 1.0);
            break;
          case "e":
            btnRotateRight.classList.add("active");
            sendControlCommand(0, -1.0);
            break;
          case " ":
            btnStop.classList.add("active");
            sendControlCommand(0, 0);
            break;
          case "E":
          case "e":
            if (e.ctrlKey) {
              toggleEmergencyStop();
            }
            break;
        }
      });

      document.addEventListener("keyup", (e) => {
        btnForward.classList.remove("active");
        btnBack.classList.remove("active");
        btnLeft.classList.remove("active");
        btnRight.classList.remove("active");
        btnRotateLeft.classList.remove("active");
        btnRotateRight.classList.remove("active");
        btnStop.classList.remove("active");
        sendControlCommand(0, 0);
      });

      // åˆå§‹åŒ–ç³»ç»Ÿ
      window.addEventListener("load", () => {
        mapSystem = new MapInteraction("slam-map-canvas");
        updateRecordStatus();

        // æ·»åŠ å‡ ä¸ªç¤ºä¾‹å¯¼èˆªç‚¹
        if (mapSystem) {
          mapSystem.addWaypoint(3.2, 2.5, "å……ç”µç«™");
          mapSystem.addWaypoint(5.7, 4.1, "åŒºåŸŸA");
          mapSystem.addWaypoint(7.4, 1.9, "ç‰©å“B");
        }

        logSafetyEvent("normal", "[ç³»ç»Ÿ] æœºå™¨äººç‰©è”ç½‘äº‘æ§ç³»ç»Ÿå·²å¯åŠ¨");
        logSafetyEvent("normal", "[ç³»ç»Ÿ] æ‰€æœ‰åŠŸèƒ½æ¨¡å—åŠ è½½å®Œæˆ");
      });
      // è·¯å¾„è§„åˆ’ç³»ç»Ÿ
      class PathPlanningSystem {
        constructor(canvasId) {
          this.canvas = document.getElementById(canvasId);
          this.ctx = this.canvas.getContext("2d");
          this.state = {
            scale: 1.0,
            offset: { x: 0, y: 0 },
            isDragging: false,
            startDragPos: { x: 0, y: 0 },
            startDragOffset: { x: 0, y: 0 },
            addWaypointMode: false,
          };

          this.waypoints = [];
          this.plannedPath = [];
          this.setupListeners();
          this.render();
        }

        setupListeners() {
          // ç¼©æ”¾æ§åˆ¶
          this.canvas.addEventListener("wheel", (e) => this.handleZoom(e));

          // æ‹–æ‹½æ§åˆ¶
          this.canvas.addEventListener("mousedown", (e) => this.startDrag(e));
          this.canvas.addEventListener("mousemove", (e) => this.handleDrag(e));
          this.canvas.addEventListener("mouseup", (e) => this.endDrag());
          this.canvas.addEventListener("mouseleave", (e) => this.endDrag());

          // è·¯å¾„ç‚¹æ·»åŠ 
          this.canvas.addEventListener("click", (e) =>
            this.handleCanvasClick(e)
          );
        }

        handleCanvasClick(e) {
          if (!this.state.addWaypointMode) return;

          const rect = this.canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          // è½¬æ¢ä¸ºä¸–ç•Œåæ ‡ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
          const worldX = (x - this.state.offset.x) / this.state.scale;
          const worldY = (y - this.state.offset.y) / this.state.scale;

          this.addWaypoint(worldX, worldY);
        }

        addWaypoint(x, y) {
          const waypoint = {
            id: `wp_${Date.now()}`,
            x: x,
            y: y,
            label: `ç‚¹${this.waypoints.length + 1}`,
            timestamp: Date.now(),
          };

          this.waypoints.push(waypoint);

          // å‘é€åˆ°åç«¯
          socket.emit("add_path_waypoint", {
            x: x,
            y: y,
            label: waypoint.label,
          });

          this.render();
          this.updateWaypointList();

          return waypoint;
        }

        clearWaypoints() {
          this.waypoints = [];
          this.plannedPath = [];
          socket.emit("clear_path_waypoints");
          this.render();
          this.updateWaypointList();
        }

        updateWaypointList() {
          const listElement = document.getElementById("nav-points-list");
          if (!listElement) return;

          if (this.waypoints.length === 0) {
            listElement.innerHTML =
              '<div style="text-align: center; color: #7f8c8d; padding: 20px;">æš‚æ— å¯¼èˆªç‚¹ï¼Œå³é”®ç‚¹å‡»åœ°å›¾æ·»åŠ </div>';
            return;
          }

          listElement.innerHTML = this.waypoints
            .map(
              (wp) => `
                    <li>
                        <div class="point-info">
                            <div><strong>${wp.label}</strong></div>
                            <div>ä¸–ç•Œåæ ‡: (${wp.x.toFixed(2)}, ${wp.y.toFixed(
                2
              )})</div>
                            ${
                              wp.pixel_x
                                ? `<div style="font-size: 0.8em; color: #888;">åƒç´ åæ ‡: (${wp.pixel_x}, ${wp.pixel_y})</div>`
                                : ""
                            }
                        </div>
                        <div class="point-actions">
                            <button onclick="mapSystem.deleteWaypoint(${
                              wp.id
                            })"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </li>
                `
            )
            .join("");
        }

        deleteWaypoint(id) {
          this.waypoints = this.waypoints.filter((wp) => wp.id !== id);
          this.render();
          this.updateWaypointList();
        }

        planPath() {
          if (this.waypoints.length < 2) {
            alert("è¯·è‡³å°‘æ·»åŠ 2ä¸ªè·¯å¾„ç‚¹");
            return;
          }

          const optimizationMethod = document.getElementById(
            "optimization-method"
          ).value;
          const smoothingMethod =
            document.getElementById("smoothing-method").value;

          socket.emit("plan_path", {
            optimization_method: optimizationMethod,
            smoothing_method: smoothingMethod,
          });
        }

        visualizePath(pathData) {
          this.plannedPath = pathData.optimized_points || [];
          this.render();
        }

        render() {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

          // ç»˜åˆ¶ç½‘æ ¼
          this.drawGrid();

          // ç»˜åˆ¶åæ ‡è½´
          this.drawCoordinateSystem();

          // ç»˜åˆ¶è·¯å¾„ç‚¹
          this.drawWaypoints();

          // ç»˜åˆ¶è§„åˆ’è·¯å¾„
          this.drawPlannedPath();
        }

        drawGrid() {
          this.ctx.strokeStyle = "#2d3748";
          this.ctx.lineWidth = 0.5;

          const gridSize = 50;

          for (let x = 0; x < this.canvas.width; x += gridSize) {
            this.ctx.beginPath();
            this.ctx.moveTo(x, 0);
            this.ctx.lineTo(x, this.canvas.height);
            this.ctx.stroke();
          }

          for (let y = 0; y < this.canvas.height; y += gridSize) {
            this.ctx.beginPath();
            this.ctx.moveTo(0, y);
            this.ctx.lineTo(this.canvas.width, y);
            this.ctx.stroke();
          }
        }

        drawCoordinateSystem() {
          this.ctx.strokeStyle = "#4299e1";
          this.ctx.lineWidth = 2;

          // åŸç‚¹
          const originX = -this.state.offset.x / this.state.scale;
          const originY = -this.state.offset.y / this.state.scale;

          // Xè½´
          this.ctx.beginPath();
          this.ctx.moveTo(0, originY);
          this.ctx.lineTo(this.canvas.width, originY);
          this.ctx.stroke();

          // Yè½´
          this.ctx.beginPath();
          this.ctx.moveTo(originX, 0);
          this.ctx.lineTo(originX, this.canvas.height);
          this.ctx.stroke();
        }

        drawWaypoints() {
          this.waypoints.forEach((wp, index) => {
            const screenPos = this.worldToScreen(wp.x, wp.y);

            // ç»˜åˆ¶ç‚¹
            this.ctx.fillStyle = "#e74c3c";
            this.ctx.beginPath();
            this.ctx.arc(screenPos.x, screenPos.y, 8, 0, Math.PI * 2);
            this.ctx.fill();

            // ç»˜åˆ¶åºå·
            this.ctx.fillStyle = "white";
            this.ctx.font = "bold 14px Arial";
            this.ctx.textAlign = "center";
            this.ctx.textBaseline = "middle";
            this.ctx.fillText((index + 1).toString(), screenPos.x, screenPos.y);

            // ç»˜åˆ¶æ ‡ç­¾
            this.ctx.fillStyle = "#cbd5e0";
            this.ctx.font = "12px Arial";
            this.ctx.fillText(wp.label, screenPos.x, screenPos.y - 15);
          });
        }

        drawPlannedPath() {
          if (this.plannedPath.length < 2) return;

          // ç»˜åˆ¶å¹³æ»‘è·¯å¾„
          this.ctx.strokeStyle = "#2ecc71";
          this.ctx.lineWidth = 3;
          this.ctx.setLineDash([]);

          this.ctx.beginPath();

          this.plannedPath.forEach((point, index) => {
            const screenPos = this.worldToScreen(point[0], point[1]);

            if (index === 0) {
              this.ctx.moveTo(screenPos.x, screenPos.y);
            } else {
              this.ctx.lineTo(screenPos.x, screenPos.y);
            }
          });

          this.ctx.stroke();

          // ç»˜åˆ¶è·¯å¾„ç‚¹ï¼ˆå°åœ†ç‚¹ï¼‰
          this.plannedPath.forEach((point) => {
            const screenPos = this.worldToScreen(point[0], point[1]);

            this.ctx.fillStyle = "#27ae60";
            this.ctx.beginPath();
            this.ctx.arc(screenPos.x, screenPos.y, 3, 0, Math.PI * 2);
            this.ctx.fill();
          });
        }

        worldToScreen(worldX, worldY) {
          return {
            x: worldX * this.state.scale + this.state.offset.x,
            y: worldY * this.state.scale + this.state.offset.y,
          };
        }

        handleZoom(e) {
          e.preventDefault();

          const mousePos = this.getMousePosition(e);
          const scaleFactor = 0.1;
          const oldScale = this.state.scale;
          const newScale = Math.max(
            0.1,
            Math.min(
              10.0,
              oldScale * (1 + (e.deltaY > 0 ? -scaleFactor : scaleFactor))
            )
          );

          this.state.offset.x -=
            (mousePos.x / oldScale - mousePos.x / newScale) * newScale;
          this.state.offset.y -=
            (mousePos.y / oldScale - mousePos.y / newScale) * newScale;

          this.state.scale = newScale;
          document.getElementById("path-scale-display").textContent =
            newScale.toFixed(2);
          this.render();
        }

        getMousePosition(e) {
          const rect = this.canvas.getBoundingClientRect();
          return {
            x: (e.clientX - rect.left - this.state.offset.x) / this.state.scale,
            y: (e.clientY - rect.top - this.state.offset.y) / this.state.scale,
          };
        }

        startDrag(e) {
          this.state.isDragging = true;
          this.state.startDragPos = { x: e.clientX, y: e.clientY };
          this.state.startDragOffset = { ...this.state.offset };
          this.canvas.style.cursor = "grabbing";
        }

        handleDrag(e) {
          if (!this.state.isDragging) return;

          const deltaX = e.clientX - this.state.startDragPos.x;
          const deltaY = e.clientY - this.state.startDragPos.y;

          this.state.offset.x = this.state.startDragOffset.x + deltaX;
          this.state.offset.y = this.state.startDragOffset.y + deltaY;

          this.render();
        }

        endDrag() {
          this.state.isDragging = false;
          this.canvas.style.cursor = "crosshair";
        }

        zoomIn() {
          this.state.scale = Math.min(10.0, this.state.scale * 1.2);
          document.getElementById("path-scale-display").textContent =
            this.state.scale.toFixed(2);
          this.render();
        }

        zoomOut() {
          this.state.scale = Math.max(0.1, this.state.scale / 1.2);
          document.getElementById("path-scale-display").textContent =
            this.state.scale.toFixed(2);
          this.render();
        }

        resetView() {
          this.state.scale = 1.0;
          this.state.offset = {
            x: this.canvas.width / 2,
            y: this.canvas.height / 2,
          };
          document.getElementById("path-scale-display").textContent = "1.00";
          this.render();
        }

        toggleAddWaypointMode() {
          this.state.addWaypointMode = !this.state.addWaypointMode;
          this.canvas.style.cursor = this.state.addWaypointMode
            ? "crosshair"
            : "default";

          const btn = document.getElementById("btn-add-waypoint-mode");
          if (this.state.addWaypointMode) {
            btn.classList.add("active");
            btn.innerHTML =
              '<i class="fas fa-map-marker-alt"></i> æ·»åŠ æ¨¡å¼ä¸­...';
          } else {
            btn.classList.remove("active");
            btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> æ·»åŠ è·¯å¾„ç‚¹';
          }
        }

        loadDemoPath() {
          this.clearWaypoints();

          // æ·»åŠ æ¼”ç¤ºè·¯å¾„ç‚¹
          const demoPoints = [
            { x: 2, y: 2, label: "èµ·ç‚¹" },
            { x: 5, y: 3, label: "ç‚¹A" },
            { x: 8, y: 1, label: "ç‚¹B" },
            { x: 6, y: -2, label: "ç‚¹C" },
            { x: 3, y: -1, label: "ç‚¹D" },
            { x: 1, y: 1, label: "ç»ˆç‚¹" },
          ];

          demoPoints.forEach((point) => {
            this.addWaypoint(point.x, point.y, point.label);
          });

          setTimeout(() => {
            this.planPath();
          }, 500);
        }
      }

      // å…¨å±€å˜é‡
      let pathPlanningSystem;

      // SocketIO è·¯å¾„è§„åˆ’äº‹ä»¶å¤„ç†
      socket.on("path_waypoint_added", function (waypoint) {
        if (pathPlanningSystem) {
          pathPlanningSystem.updateWaypointList();
        }
      });

      socket.on("path_waypoints_cleared", function () {
        if (pathPlanningSystem) {
          pathPlanningSystem.waypoints = [];
          pathPlanningSystem.plannedPath = [];
          pathPlanningSystem.render();
          pathPlanningSystem.updateWaypointList();
        }
      });

      socket.on("path_planned", function (pathData) {
        if (pathPlanningSystem) {
          pathPlanningSystem.visualizePath(pathData);
          showNotification("è·¯å¾„è§„åˆ’å®Œæˆ", "success");
        }
      });

      socket.on("path_planning_error", function (data) {
        showNotification(`è·¯å¾„è§„åˆ’é”™è¯¯: ${data.message}`, "error");
      });

      socket.on("path_execution_started", function (data) {
        document.getElementById("path-execution-status").innerHTML = `
        <div>çŠ¶æ€: <span style="color: #27ae60;">æ‰§è¡Œä¸­</span></div>
        <div>è¿›åº¦: <span id="path-progress">0</span>/<span id="path-total">${data.total_points}</span></div>
    `;
        showNotification("è·¯å¾„æ‰§è¡Œå¼€å§‹", "success");
      });

      socket.on("path_point_reached", function (data) {
        document.getElementById("path-progress").textContent = data.point_index;
      });

      socket.on("path_execution_complete", function (data) {
        document.getElementById("path-execution-status").innerHTML = `
        <div>çŠ¶æ€: <span style="color: #3498db;">å·²å®Œæˆ</span></div>
        <div>è¿›åº¦: <span id="path-progress">${data.total_points}</span>/<span id="path-total">${data.total_points}</span></div>
    `;
        showNotification("è·¯å¾„æ‰§è¡Œå®Œæˆ", "success");
      });
      // åœ¨åœ°å›¾æ•°æ®æ¥æ”¶å¤„æ·»åŠ è°ƒè¯•
      socket.on("map_data", function (data) {
        console.log("ğŸ“¨ æ”¶åˆ°åœ°å›¾æ•°æ®ï¼", data);
        console.log(
          "åœ°å›¾å°ºå¯¸:",
          data.metadata.width,
          "x",
          data.metadata.height
        );
        console.log("æ•°æ®é•¿åº¦:", data.data.length);

        // ç»Ÿè®¡æ•°æ®
        let free = 0,
          occupied = 0,
          unknown = 0;
        for (let i = 0; i < Math.min(100, data.data.length); i++) {
          if (data.data[i] === 0) free++;
          else if (data.data[i] === 100) occupied++;
          else if (data.data[i] === -1) unknown++;
        }
        console.log(
          "æ•°æ®æ ·æœ¬åˆ†å¸ƒ - ç©ºé—²:",
          free,
          "éšœç¢:",
          occupied,
          "æœªçŸ¥:",
          unknown
        );

        if (mapSystem) {
          console.log("ğŸ”„ è®¾ç½®åœ°å›¾æ•°æ®åˆ°mapSystem...");
          mapSystem.state.mapData = data;
          mapSystem.updateMapParameters(data.metadata);
          mapSystem.render();
          console.log("âœ… åœ°å›¾æ¸²æŸ“å®Œæˆ");
        } else {
          console.log("âŒ mapSystemæœªåˆå§‹åŒ–");
        }
      });
      socket.on("path_execution_stopped", function (data) {
        document.getElementById("path-execution-status").innerHTML = `
        <div>çŠ¶æ€: <span style="color: #e74c3c;">å·²åœæ­¢</span></div>
        <div>è¿›åº¦: <span id="path-progress">${data.completed_points}</span>/<span id="path-total">0</span></div>
    `;
        showNotification("è·¯å¾„æ‰§è¡Œå·²åœæ­¢", "warning");
      });

      // åˆå§‹åŒ–è·¯å¾„è§„åˆ’ç³»ç»Ÿ
      function initPathPlanningSystem() {
        pathPlanningSystem = new PathPlanningSystem("path-planning-canvas");

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document
          .getElementById("btn-add-waypoint-mode")
          .addEventListener("click", function () {
            pathPlanningSystem.toggleAddWaypointMode();
          });

        document
          .getElementById("btn-clear-waypoints")
          .addEventListener("click", function () {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è·¯å¾„ç‚¹å—ï¼Ÿ")) {
              pathPlanningSystem.clearWaypoints();
            }
          });

        document
          .getElementById("btn-plan-path")
          .addEventListener("click", function () {
            pathPlanningSystem.planPath();
          });

        document
          .getElementById("btn-start-path")
          .addEventListener("click", function () {
            socket.emit("start_path_execution");
          });

        document
          .getElementById("btn-stop-path")
          .addEventListener("click", function () {
            socket.emit("stop_path_execution");
          });

        document
          .getElementById("btn-load-demo")
          .addEventListener("click", function () {
            pathPlanningSystem.loadDemoPath();
          });

        // åˆå§‹åŠ è½½è·¯å¾„ç‚¹
        socket.emit("get_path_waypoints");
      }

      // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener("load", function () {
        // ... å…¶ä»–åˆå§‹åŒ–ä»£ç  ...
        initPathPlanningSystem();
      });

      // å·¥å…·å‡½æ•°
      function showNotification(message, type = "info") {
        // ç®€å•çš„é€šçŸ¥å®ç°
        const notification = document.createElement("div");
        notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        z-index: 1000;
        font-weight: bold;
        transition: opacity 0.3s;
    `;

        if (type === "success") {
          notification.style.background = "#27ae60";
        } else if (type === "error") {
          notification.style.background = "#e74c3c";
        } else if (type === "warning") {
          notification.style.background = "#f39c12";
        } else {
          notification.style.background = "#3498db";
        }

        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.opacity = "0";
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }
    </script>
  </body>
</html>
